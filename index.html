<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Aromatlas ‚Äì Fiche de d√©gustation</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="icon" type="image/png" href="img/ico.png">

  <!-- Tailwind v4 via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- Chart.js et html2pdf pour le radar et l‚Äôexport PDF -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      color-scheme: light dark;

      /* Palette claire par d√©faut */
      --color-bg: #f5f5f7;
      --color-bg-gradient: radial-gradient(circle at top, #e5e7eb, #f5f5f7 45%, #e5e7eb 100%);
      --color-surface: rgba(255, 255, 255, 0.98);
      --color-surface-soft: rgba(255, 255, 255, 0.94);
      --color-border-subtle: rgba(148, 163, 184, 0.28);
      --color-text: #020617;
      --color-muted: #6b7280;
      --color-accent: #2563eb;
      --color-accent-soft: rgba(37, 99, 235, 0.12);
      --shadow-elevated: 0 24px 60px rgba(15, 23, 42, 0.14);
      --radius-lg: 22px;
      --radius-md: 14px;
      --radius-pill: 999px;
      --glass-surface: rgba(255, 255, 255, 0.86);
      --glass-blur: blur(22px);

      /* Couleur pour les badges d‚Äôar√¥mes */
      --accent1: #fbbf24;

      /* Pont avec les anciens noms de variables utilis√©s dans la palette */
      --background: var(--color-bg-gradient);
      --card-bg: var(--color-surface-soft);
      --text: var(--color-text);
      --muted: var(--color-muted);
      --accent: var(--color-accent);
      --glass-bg: var(--glass-surface);
      --card: var(--color-surface-soft);
      --ink: var(--color-text);
      --line: var(--color-border-subtle);
    }

    /* Th√®me fonc√© automatique */
    @media (prefers-color-scheme: dark) {
      :root {
        --color-bg: #020617;
        --color-bg-gradient: radial-gradient(circle at top, #0f172a, #020617 52%, #000000 100%);
        --color-surface: rgba(15, 23, 42, 0.98);
        --color-surface-soft: rgba(15, 23, 42, 0.96);
        --color-border-subtle: rgba(148, 163, 184, 0.35);
        --color-text: #e5e7eb;
        --color-muted: #9ca3af;
        --color-accent: #38bdf8;
        --color-accent-soft: rgba(56, 189, 248, 0.18);
        --shadow-elevated: 0 26px 70px rgba(0, 0, 0, 0.8);
        --glass-surface: rgba(15, 23, 42, 0.9);

        --background: var(--color-bg-gradient);
        --card-bg: var(--color-surface-soft);
        --text: var(--color-text);
        --muted: var(--color-muted);
        --accent: var(--color-accent);
        --glass-bg: var(--glass-surface);
        --card: var(--color-surface-soft);
        --ink: var(--color-text);
        --line: var(--color-border-subtle);
      }
    }

    /* Overrides explicites */
    :root[data-theme="light"] {
      --color-bg: #f5f5f7;
      --color-bg-gradient: radial-gradient(circle at top, #e5e7eb, #f5f5f7 45%, #e5e7eb 100%);
      --color-surface: rgba(255, 255, 255, 0.98);
      --color-surface-soft: rgba(255, 255, 255, 0.94);
      --color-border-subtle: rgba(148, 163, 184, 0.26);
      --color-text: #020617;
      --color-muted: #6b7280;
      --color-accent: #2563eb;
      --color-accent-soft: rgba(37, 99, 235, 0.12);
      --shadow-elevated: 0 22px 60px rgba(15, 23, 42, 0.16);
      --glass-surface: rgba(255, 255, 255, 0.9);
      --glass-blur: blur(22px);

      --background: var(--color-bg-gradient);
      --card-bg: var(--color-surface-soft);
      --text: var(--color-text);
      --muted: var(--color-muted);
      --accent: var(--color-accent);
      --glass-bg: var(--glass-surface);
      --card: var(--color-surface-soft);
      --ink: var(--color-text);
      --line: var(--color-border-subtle);
    }
    :root[data-theme="dark"] {
      --color-bg: #020617;
      --color-bg-gradient: radial-gradient(circle at top, #0f172a, #020617 52%, #000000 100%);
      --color-surface: rgba(15, 23, 42, 0.98);
      --color-surface-soft: rgba(15, 23, 42, 0.96);
      --color-border-subtle: rgba(148, 163, 184, 0.4);
      --color-text: #e5e7eb;
      --color-muted: #9ca3af;
      --color-accent: #38bdf8;
      --color-accent-soft: rgba(56, 189, 248, 0.18);
      --shadow-elevated: 0 26px 72px rgba(0, 0, 0, 0.85);
      --glass-surface: rgba(15, 23, 42, 0.9);

      --background: var(--color-bg-gradient);
      --card-bg: var(--color-surface-soft);
      --text: var(--color-text);
      --muted: var(--color-muted);
      --accent: var(--color-accent);
      --glass-bg: var(--glass-surface);
      --card: var(--color-surface-soft);
      --ink: var(--color-text);
      --line: var(--color-border-subtle);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, -system-ui, 'Segoe UI', Roboto, sans-serif;
      background: var(--color-bg-gradient, var(--color-bg));
      color: var(--color-text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      overflow-x: hidden;
      scroll-behavior: smooth;
      transition: background 0.28s ease, color 0.2s ease;
    }

    body, .card, .app-header, .overlay, .palette {
      transition: background-color 0.25s ease, background 0.25s ease, color 0.25s ease, border-color 0.25s ease;
    }

    .app-shell {
      width: 100%;
      max-width: 1080px;
      margin: 0 auto;
      padding: 0 clamp(12px, 4vw, 24px) 32px;
      padding-top: env(safe-area-inset-top, 0px);
      padding-bottom: calc(32px + env(safe-area-inset-bottom, 0px));
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* ---------- En-t√™te ---------- */
    .app-header {
      position: sticky;
      top: 0;
      z-index: 40;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 16px;
      margin: 0 -4px 4px;
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      background: linear-gradient(120deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.9));
      backdrop-filter: var(--glass-blur);
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 20px 55px rgba(15, 23, 42, 0.18);
    }
    :root[data-theme="dark"] .app-header {
      background: linear-gradient(120deg, rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 0.96));
      border-color: rgba(148, 163, 184, 0.5);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }
    .logo {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      object-fit: contain;
      flex-shrink: 0;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.28);
    }
    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .title {
      margin: 0;
      font-size: clamp(19px, 2.1vw, 22px);
      font-weight: 700;
      letter-spacing: 0.02em;
      white-space: nowrap;
    }
    .subtitle {
      margin: 0;
      font-size: 12px;
      color: var(--color-muted);
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(148, 163, 184, 0.04);
      color: var(--color-text);
      transition: background 0.16s ease, color 0.16s ease, box-shadow 0.16s ease, border-color 0.16s ease, transform 0.09s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn .icon {
      font-size: 15px;
      line-height: 1;
    }
    .btn.primary {
      background: linear-gradient(135deg, var(--color-accent) 0%, #1d4ed8 100%);
      color: #ffffff;
      box-shadow: 0 12px 26px rgba(37, 99, 235, 0.55);
      border-color: rgba(15, 23, 42, 0.16);
    }
    .btn.primary:hover {
      transform: translateY(-0.5px);
      box-shadow: 0 16px 32px rgba(37, 99, 235, 0.65);
    }
    .btn.secondary {
      background: rgba(148, 163, 184, 0.08);
      border-color: rgba(148, 163, 184, 0.45);
      color: var(--color-text);
    }
    .btn.secondary:hover {
      background: rgba(148, 163, 184, 0.16);
    }
    .btn.icon-only {
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 999px;
      border-color: rgba(148, 163, 184, 0.6);
      background: rgba(148, 163, 184, 0.1);
      flex-shrink: 0;
    }
    .btn.icon-only .label {
      display: none;
    }

    .btn:focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }
    .btn:active {
      transform: scale(0.97);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.25);
    }

    .btn.small {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 999px;
    }

    .btn-ghost-accent {
      background: var(--color-accent-soft);
      color: var(--color-accent);
      border-color: transparent;
    }

    .app-main {
      display: flex;
      flex-direction: column;
      gap: 18px;
      margin-top: 4px;
    }

    /* ---------- Cartes ---------- */
    .card {
      background: var(--color-surface-soft);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.54);
      box-shadow: var(--shadow-elevated);
      padding: clamp(16px, 3vw, 24px);
      display: flex;
      flex-direction: column;
      gap: 16px;
      backdrop-filter: var(--glass-blur);
    }
    :root[data-theme="dark"] .card {
      border-color: rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.12), rgba(15, 23, 42, 0.96));
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .card h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 650;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card h2 .emoji {
      font-size: 1.2em;
    }

    /* ---------- Formulaire d‚Äôinformations ---------- */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 14px 18px;
    }
    .info-grid-item label {
      display: block;
      margin-bottom: 4px;
      font-size: 13px;
      font-weight: 600;
      color: var(--color-muted);
    }

    .input,
    .textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--color-border-subtle);
      background: var(--color-surface);
      padding: 9px 12px;
      font-size: 14px;
      color: var(--color-text);
      outline: none;
      transition: border-color 0.16s ease, box-shadow 0.16s ease, background-color 0.16s ease;
    }
    .input::placeholder,
    .textarea::placeholder {
      color: var(--color-muted);
      opacity: 0.8;
    }
    .input:focus,
    .textarea:focus {
      border-color: var(--color-accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.7);
      background: var(--color-surface);
    }
    .textarea {
      min-height: 96px;
      resize: vertical;
    }

    .notes-block label {
      display: block;
      margin-bottom: 4px;
      font-size: 13px;
      font-weight: 600;
      color: var(--color-muted);
    }

    .flags-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px 18px;
      margin-top: 4px;
    }
    .checkbox-item {
      position: relative;
      display: flex;
      align-items: center;
      font-size: 14px;
      color: var(--color-text);
      min-width: 0;
    }
    .checkbox-item input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    .checkbox-item label {
      position: relative;
      padding-left: 52px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .checkbox-item label::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 24px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.28);
      transition: background 0.22s ease;
    }
    .checkbox-item label::after {
      content: '';
      position: absolute;
      left: 3px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #ffffff;
      box-shadow: 0 3px 7px rgba(15, 23, 42, 0.35);
      transition: transform 0.22s ease;
    }
    .checkbox-item input:checked + label::before {
      background: var(--color-accent);
    }
    .checkbox-item input:checked + label::after {
      transform: translate(20px, -50%);
    }

    /* ---------- Profil sensoriel ---------- */
    .sensor-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: stretch;
    }
    .metrics {
      flex: 1 1 260px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .metric-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .metric-row label {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-muted);
    }
    .range-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .range-wrap output {
      min-width: 24px;
      text-align: right;
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text);
    }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 4px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.35);
      outline: none;
      cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: var(--color-accent);
      box-shadow: 0 3px 7px rgba(15, 23, 42, 0.4);
      cursor: pointer;
      transition: background 0.16s ease, transform 0.08s ease;
      margin-top: -6px; /* Alignement vertical chrome */
    }
    /* Correctif pour Chrome/Safari pour aligner le thumb sur la track */
    input[type="range"]::-webkit-slider-runnable-track {
        height: 4px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.35);
    }
    input[type="range"]:active::-webkit-slider-thumb {
      transform: scale(1.02);
    }
    input[type="range"]::-moz-range-track {
      width: 100%;
      height: 4px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.35);
      outline: none;
    }
    input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: var(--color-accent);
      box-shadow: 0 3px 7px rgba(15, 23, 42, 0.4);
      cursor: pointer;
      border: none;
      transition: background 0.16s ease, transform 0.08s ease;
    }

    .radar-shell {
      flex: 0 0 280px;
      max-width: 100%;
      min-height: 260px;
      position: relative;
    }
    .radar-shell canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* ---------- Notation (Redesign) ---------- */
    .score-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
    }

    .score-control {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .score-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .score-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-text);
    }
    .score-val-display {
      font-size: 14px;
      font-weight: 700;
      color: var(--color-accent);
      font-variant-numeric: tabular-nums;
    }
    .score-val-display span {
      font-weight: 400;
      color: var(--color-muted);
      font-size: 13px;
    }

    .score-input-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--color-surface);
      border: 1px solid var(--color-border-subtle);
      padding: 6px 8px;
      border-radius: 999px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    }

    .score-btn {
      width: 32px;
      height: 32px;
      flex-shrink: 0;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--color-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      line-height: 1;
      transition: all 0.15s ease;
      user-select: none;
    }
    .score-btn:hover {
      background: rgba(148, 163, 184, 0.15);
      color: var(--color-text);
    }
    .score-btn:active {
      background: rgba(148, 163, 184, 0.25);
      transform: scale(0.92);
    }
    .score-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .score-slider {
      flex: 1;
      -webkit-appearance: none;
      height: 6px;
      background: transparent; /* g√©r√© via JS pour le d√©grad√© */
      border-radius: 999px;
      outline: none;
      cursor: pointer;
      position: relative;
    }
    /* Slider Track Styles */
    .score-slider::-webkit-slider-runnable-track {
        height: 6px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.2);
    }
    .score-slider::-moz-range-track {
        height: 6px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.2);
    }
    
    /* Slider Thumb Styles */
    .score-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      border: 2px solid var(--color-accent);
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      margin-top: -7px; /* (20 - 6) / 2 * -1 */
      transition: transform 0.1s;
    }
    .score-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      border: 2px solid var(--color-accent);
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      border: none; /* Firefox border fix */
      transition: transform 0.1s;
    }
    
    .score-slider:active::-webkit-slider-thumb { transform: scale(1.15); }
    .score-slider:active::-moz-range-thumb { transform: scale(1.15); }

    .total-row {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 600;
    }
    .total-label {
      color: var(--color-muted);
    }
    .total-value {
      padding: 4px 14px;
      border-radius: 999px;
      background: var(--color-accent);
      color: #ffffff;
      min-width: 90px;
      text-align: center;
      font-variant-numeric: tabular-nums;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    /* ---------- Ar√¥mes (chips) ---------- */
    .aroma-controls {
      display: flex;
      justify-content: flex-start;
      align-items: center;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      background: linear-gradient(120deg, var(--color-accent) 0%, #1d4ed8 100%);
      color: #ffffff;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.4);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
      max-width: 100%;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.4);
    }

    /* Couleurs par famille pour les pastilles */
    .chip.fam-fruite { background: #fef3c7 !important; color: #92400e !important; }
    .chip.fam-floral { background: #fce7f3 !important; color: #9d174d !important; }
    .chip.fam-herbace { background: #dcfce7 !important; color: #166534 !important; }
    .chip.fam-cereale { background: #f5ebe0 !important; color: #92400e !important; }
    .chip.fam-queue { background: #e5e7eb !important; color: #374151 !important; }
    .chip.fam-tourbe { background: #e5e7f0 !important; color: #111827 !important; }
    .chip.fam-elevage { background: #fef3c7 !important; color: #854d0e !important; }

    /* ---------- Overlay / Palette d‚Äôar√¥mes ---------- */
    .overlay {
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(15, 23, 42, 0.65);
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding: 40px 16px;
    }
    .overlay[aria-hidden="false"],
    .overlay.open {
      display: flex;
    }

    .palette {
      width: min(100%, 640px);
      max-height: 80vh;
      background: var(--glass-surface);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.6);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: var(--glass-blur);
      color: var(--color-text);
    }

    .palette .bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--color-border-subtle);
      background: rgba(15, 23, 42, 0.02);
    }
    .palette .bar input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--color-border-subtle);
      background: var(--color-surface);
      padding: 8px 12px;
      font-size: 14px;
      color: var(--color-text);
      outline: none;
    }
    .palette .bar input::placeholder {
      color: var(--color-muted);
      opacity: 0.9;
    }
    .palette .bar input:focus {
      border-color: var(--color-accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.7);
      background: var(--color-surface);
    }

    .results {
      flex: 1;
      overflow-y: auto;
      padding: 8px 10px 10px;
    }
    .results .row {
      display: flex;
      align-items: baseline;
      gap: 8px;
      padding: 6px 6px;
      border-radius: 10px;
      cursor: pointer;
      position: relative;
    }
    .results .row:hover {
      background: rgba(37, 99, 235, 0.08);
    }

    .results .row[aria-selected="true"] {
      background: transparent;
      color: inherit;
    }
    .results .row[aria-selected="true"]::after {
      content: '';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--color-muted);
      opacity: 0.7;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
    }

    .leaf-badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent1);
      color: #111827;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      max-width: 60%;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .leaf-badge.fam-fruite { background: #fef3c7 !important; color: #92400e !important; }
    .leaf-badge.fam-floral { background: #fce7f3 !important; color: #9d174d !important; }
    .leaf-badge.fam-herbace { background: #dcfce7 !important; color: #166534 !important; }
    .leaf-badge.fam-cereale { background: #f5ebe0 !important; color: #92400e !important; }
    .leaf-badge.fam-queue { background: #e5e7eb !important; color: #374151 !important; }
    .leaf-badge.fam-tourbe { background: #e5e7f0 !important; color: #111827 !important; }
    .leaf-badge.fam-elevage { background: #fef3c7 !important; color: #854d0e !important; }

    .path {
      font-size: 12px;
      color: var(--color-muted);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 40%;
    }

    /* Infobulle */
    .tip {
      position: fixed;
      z-index: 1100;
      max-width: 280px;
      background: rgba(255, 255, 255, 0.96);
      color: var(--color-text);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 12px 14px;
      font-size: 12px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(16px);
      display: none;
    }
    .tip h4 {
      margin: 0 0 6px;
      font-size: 13px;
      font-weight: 700;
    }
    .tip h4 small {
      font-size: 11px;
      font-weight: 400;
      color: var(--color-muted);
    }
    .tip .line {
      display: flex;
      margin-bottom: 4px;
    }
    .tip .line .k {
      flex: 0 0 80px;
      font-weight: 600;
      color: var(--color-muted);
    }
    .tip .line .v {
      flex: 1;
    }

    /* ---------- PDF (gabarit cach√©) ---------- */
    #pdfTemplate {
      display: none;
    }

    .pdf-sheet {
      background: #ffffff;
      color: #111827;
      padding: 32px 26px;
      width: 190mm;
      max-width: none;
      margin: 0;
      border-radius: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
    }
    .pdf-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 14px;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 16px;
    }
    .pdf-logo {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      object-fit: contain;
    }
    .pdf-header-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .pdf-title {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: #1d4ed8;
    }
    .pdf-subtitle {
      margin: 0;
      font-size: 11px;
      color: #6b7280;
    }

    .pdf-info-section {
      margin-bottom: 18px;
    }
    .pdf-info {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .pdf-info th,
    .pdf-info td {
      padding: 5px 6px;
      border-bottom: 1px solid #e5e7eb;
    }
    .pdf-info th {
      background: #f9fafb;
      color: #6b7280;
      text-align: left;
      font-weight: 600;
    }
    .pdf-info td {
      color: #111827;
    }

    .pdf-flags {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 10px;
    }
    .pdf-flags .flag {
      padding: 3px 7px;
      border-radius: 999px;
      background: #eff6ff;
      border: 1px solid #dbeafe;
      color: #1f2937;
    }

    .pdf-notes {
      margin-bottom: 18px;
    }
    .pdf-notes h2 {
      margin: 0 0 4px;
      font-size: 13px;
      color: #1d4ed8;
    }
    .pdf-notes p {
      margin: 0;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 8px;
      min-height: 50px;
      white-space: pre-wrap;
    }

    .pdf-main {
      display: flex;
      gap: 16px;
    }
    .pdf-left {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .pdf-right {
      flex: 1.2;
      display: flex;
      flex-direction: column;
    }
    .pdf-left h2,
    .pdf-right h2 {
      margin: 0 0 4px;
      font-size: 13px;
      color: #1d4ed8;
    }

    .pdf-aromas .chips {
      margin-top: 4px;
      gap: 4px;
    }
    .pdf-aromas .chip {
      padding: 3px 7px;
      font-size: 11px;
      border-radius: 8px;
      box-shadow: none;
      background: #f3f4f6;
      color: #111827;
    }
    .pdf-aromas .chip.fam-fruite { background: #fef3c7 !important; color: #92400e !important; }
    .pdf-aromas .chip.fam-floral { background: #fce7f3 !important; color: #9d174d !important; }
    .pdf-aromas .chip.fam-herbace { background: #dcfce7 !important; color: #166534 !important; }
    .pdf-aromas .chip.fam-cereale { background: #f5ebe0 !important; color: #92400e !important; }
    .pdf-aromas .chip.fam-queue { background: #e5e7eb !important; color: #374151 !important; }
    .pdf-aromas .chip.fam-tourbe { background: #e5e7f0 !important; color: #111827 !important; }
    .pdf-aromas .chip.fam-elevage { background: #fef3c7 !important; color: #854d0e !important; }

    .pdf-radar img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      padding: 4px;
      background: #ffffff;
    }

    .pdf-sections {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
    }
    .pdf-section h3 {
      margin: 0 0 2px;
      font-size: 12px;
      color: #1d4ed8;
    }
    .pdf-section .pdf-desc {
      margin: 0 0 4px;
      font-size: 10px;
      color: #6b7280;
      font-style: italic;
    }
    .pdf-section .criteria-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      padding: 3px 0;
      border-bottom: 1px solid #e5e7eb;
      font-size: 10px;
    }
    .criteria-row span:first-child {
      flex: 1;
    }
    .criteria-row span:last-child {
      flex: 0 0 auto;
      text-align: right;
      min-width: 60px;
    }

    .pdf-total {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px solid #e5e7eb;
      text-align: right;
      font-weight: 650;
      font-size: 12px;
      color: #1d4ed8;
    }

    /* ---------- Overlay de progression PDF ---------- */
    .export-overlay {
      position: fixed;
      inset: 0;
      z-index: 1200;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px 18px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.7), rgba(15, 23, 42, 0.92));
      backdrop-filter: blur(24px);
    }
    .export-overlay.open {
      display: flex;
    }
    .export-panel {
      width: min(420px, 100%);
      border-radius: 24px;
      background: var(--glass-surface);
      border: 1px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.7);
      padding: 18px 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      color: var(--color-text);
    }
    .export-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .export-icon {
      width: 40px;
      height: 40px;
      border-radius: 20px;
      background: radial-gradient(circle at 30% 20%, #eff6ff, #dbeafe);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1d4ed8;
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.55);
      position: relative;
      overflow: hidden;
    }
    .export-icon::after {
      content: '';
      position: absolute;
      inset: 0;
      background: conic-gradient(from 0deg, rgba(37, 99, 235, 0) 0deg, rgba(37, 99, 235, 0.28) 90deg, rgba(37, 99, 235, 0) 180deg);
      animation: export-spin 1.4s linear infinite;
      mix-blend-mode: multiply;
    }
    .export-icon span {
      position: relative;
      z-index: 1;
      font-size: 20px;
    }

    @keyframes export-spin {
      to { transform: rotate(360deg); }
    }

    .export-title {
      margin: 0;
      font-size: 16px;
      font-weight: 650;
    }
    .export-subtitle {
      margin: 0;
      font-size: 13px;
      color: var(--color-muted);
    }

    .export-progress {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .export-progress-bar {
      width: 100%;
      height: 5px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.35);
      overflow: hidden;
    }
    .export-progress-fill {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--color-accent), #38bdf8);
      transition: width 0.35s ease-out;
    }
    .export-progress-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--color-muted);
    }
    .export-progress-value {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
      color: var(--color-text);
    }

    /* ---------- Utilitaires ---------- */
    .text-muted {
      color: var(--color-muted);
    }
    .hidden-xs {
      display: inline;
    }

    @media (max-width: 480px) {
      .hidden-xs {
        display: none;
      }
    }

    /* ---------- Responsive ---------- */
    @media (max-width: 960px) {
      .form-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .flags-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .app-header {
        flex-wrap: wrap;
        align-items: flex-start;
      }
      .header-right {
        width: 100%;
        justify-content: flex-start;
      }
    }

    @media (max-width: 640px) {
      .app-shell {
        padding-inline: 12px;
      }
      .app-header {
        margin-inline: -8px;
        border-radius: 0 0 20px 20px;
        padding-inline: 12px;
        gap: 10px;
        flex-direction: column;
        align-items: flex-start;
      }
      .header-left {
        width: 100%;
        justify-content: flex-start;
      }
      .header-right {
        width: 100%;
        justify-content: flex-start;
      }
      .card {
        padding: 14px 14px 16px;
        border-radius: 18px;
      }
      .form-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .flags-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .sensor-grid {
        flex-direction: column;
      }
      .radar-shell {
        min-height: 220px;
      }
      .overlay {
        padding: 20px 10px;
      }
      .palette {
        width: 100%;
        max-height: 80vh;
        border-radius: 18px;
      }
      .btn {
        padding-inline: 10px;
      }
      .export-overlay {
        padding: 16px 12px;
      }
      .export-panel {
        border-radius: 20px;
        padding: 16px 14px 14px;
      }
    }

    @media print {
      body {
        background: #ffffff !important;
        color: #000000 !important;
      }
      .app-header,
      .btn,
      .overlay,
      .tip,
      .export-overlay {
        display: none !important;
      }
      .app-shell {
        padding: 0;
        max-width: none;
      }
      .card {
        box-shadow: none;
        border-radius: 0;
        border: none;
        padding: 0;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="header-left">
        <img src="img/ico.png" alt="Logo Aromatlas" class="logo">
        <div class="title-block">
          <h1 class="title">Aromatlas</h1>
          <p class="subtitle">Fiche de d√©gustation</p>
        </div>
      </div>
      <div class="header-right">
        <button id="themeToggle" class="btn icon-only" type="button" aria-label="Basculer le th√®me">
          <span class="icon theme-icon">üåô</span>
          <span class="label">Th√®me</span>
        </button>
        <button id="exportPdf" class="btn primary" type="button">
          <span class="icon">üñ®</span>
          <span class="hidden-xs">Exporter PDF</span>
        </button>
        <button id="resetAll" class="btn secondary" type="button">R√©initialiser</button>
      </div>
    </header>

    <main class="app-main">
      <!-- Informations principales -->
      <section class="card" aria-labelledby="infoTitle">
        <div class="card-header">
          <h2 id="infoTitle"><span class="emoji">‚ÑπÔ∏è</span> Informations</h2>
        </div>
        <div class="form-grid info-grid">
          <div class="info-grid-item">
            <label for="fDate">Date</label>
            <input id="fDate" type="date" class="input">
          </div>
          <div class="info-grid-item">
            <label for="fName">Nom</label>
            <input id="fName" type="text" class="input" placeholder="Connoisseurs Choice">
          </div>
          <div class="info-grid-item">
            <label for="fDistillery">Distillerie</label>
            <input id="fDistillery" type="text" class="input" placeholder="Balblair Distillery">
          </div>
          <div class="info-grid-item">
            <label for="fBottler">Embouteilleur</label>
            <input id="fBottler" type="text" class="input" placeholder="Gordon &amp; MacPhail">
          </div>
          <div class="info-grid-item">
            <label for="fAge">√Çge</label>
            <input id="fAge" type="text" class="input" placeholder="30 ans">
          </div>
          <div class="info-grid-item">
            <label for="fVintage">Mill√©sime</label>
            <input id="fVintage" type="text" class="input" placeholder="1993">
          </div>
          <div class="info-grid-item">
            <label for="fColor">Couleur</label>
            <input id="fColor" type="text" class="input" placeholder="Sherry">
          </div>
          <div class="info-grid-item">
            <label for="fAbv">ABV (%)</label>
            <input id="fAbv" type="number" min="0" max="100" step="0.1" class="input" placeholder="54.2">
          </div>
        </div>

        <div class="flags-grid" aria-label="Particularit√©s" role="group">
          <div class="checkbox-item">
            <input id="fCask" type="checkbox">
            <label for="fCask">Brut de f√ªt</label>
          </div>
          <div class="checkbox-item">
            <input id="fSingle" type="checkbox">
            <label for="fSingle">F√ªt unique</label>
          </div>
          <div class="checkbox-item">
            <input id="fNcf" type="checkbox">
            <label for="fNcf">Non filtr√© √† froid</label>
          </div>
          <div class="checkbox-item">
            <input id="fNoCol" type="checkbox">
            <label for="fNoCol">Non color√©</label>
          </div>
        </div>

        <div class="notes-block">
          <label for="fNotes">Notes (libres)</label>
          <textarea id="fNotes" class="textarea" placeholder="Premi√®res impressions, contexte‚Ä¶"></textarea>
        </div>
      </section>

      <!-- Notation (Nouveau design) -->
      <section class="card" aria-labelledby="scoreTitle">
        <div class="card-header">
          <h2 id="scoreTitle"><span class="emoji">üìù</span> Notation</h2>
        </div>
        <div id="scoreControls" class="score-grid" aria-label="Crit√®res de notation">
          <!-- Inject√© par JS -->
        </div>
        <div class="total-row" aria-live="polite">
          <span class="total-label">Total :</span>
          <span id="totalScore" class="total-value">0 / 100</span>
        </div>
      </section>

      <!-- Profil sensoriel -->
      <section class="card" aria-labelledby="sensorTitle">
        <div class="card-header">
          <h2 id="sensorTitle"><span class="emoji">üìä</span> Profil sensoriel</h2>
        </div>
        <div class="sensor-grid">
          <div id="metricControls" class="metrics" aria-label="Profil sensoriel"></div>
          <div class="radar-shell" aria-hidden="false">
            <canvas id="radarChart" aria-label="Radar sensoriel" role="img"></canvas>
          </div>
        </div>
      </section>

      <!-- Ar√¥mes -->
      <section class="card" aria-labelledby="aromaTitle">
        <div class="card-header">
          <h2 id="aromaTitle"><span class="emoji">üçã</span> Ar√¥mes identifi√©s</h2>
        </div>
        <div class="aroma-controls">
          <button id="openPalette" class="btn btn-ghost-accent small" type="button">Ajouter des ar√¥mes</button>
        </div>
        <div id="selectedAromas" class="chips" aria-label="Ar√¥mes s√©lectionn√©s"></div>
      </section>
    </main>
  </div>

  <!-- Palette d‚Äôar√¥mes -->
  <div id="paletteOverlay" class="overlay" aria-hidden="true">
    <div class="palette" role="dialog" aria-modal="true" aria-labelledby="paletteTitle">
      <div class="bar">
        <input id="palSearch" type="text" placeholder="Rechercher un ar√¥me‚Ä¶" aria-label="Rechercher un ar√¥me">
        <button id="palClose" class="btn small secondary" type="button" aria-label="Fermer la palette">‚úï</button>
      </div>
      <div id="palResults" class="results" role="listbox" aria-label="Liste d‚Äôar√¥mes"></div>
    </div>
  </div>

  <!-- Infobulle d‚Äôar√¥me -->
  <div id="tooltip" class="tip" role="tooltip" aria-hidden="true"></div>

  <!-- Gabarit PDF cach√© -->
  <div id="pdfTemplate" aria-hidden="true">
    <div class="pdf-sheet">
      <header class="pdf-header">
        <img src="img/ico.png" alt="Logo Aromatlas" class="pdf-logo">
        <div class="pdf-header-text">
          <h1 class="pdf-title">Fiche de d√©gustation</h1>
          <p class="pdf-subtitle">PDF g√©n√©r√© par Aromatlas le <span id="pdfGeneratedOn"></span></p>
        </div>
      </header>

      <section class="pdf-info-section">
        <table class="pdf-info">
          <tr>
            <th>Date</th><td id="pdfDate"></td>
            <th>Nom</th><td id="pdfName"></td>
          </tr>
          <tr>
            <th>Distillerie</th><td id="pdfDistillery"></td>
            <th>Embouteilleur</th><td id="pdfBottler"></td>
          </tr>
          <tr>
            <th>√Çge</th><td id="pdfAge"></td>
            <th>Mill√©sime</th><td id="pdfVintage"></td>
          </tr>
          <tr>
            <th>Couleur</th><td id="pdfColor"></td>
            <th>ABV (%)</th><td id="pdfAbv"></td>
          </tr>
        </table>
        <div id="pdfFlags" class="pdf-flags"></div>
      </section>

      <section class="pdf-notes">
        <h2>Notes</h2>
        <p id="pdfNotes"></p>
      </section>

      <section class="pdf-main">
        <div class="pdf-left">
          <div class="pdf-radar">
            <h2>Profil sensoriel</h2>
            <!-- L'image sera g√©n√©r√©e en Light Mode forc√© -->
            <img id="pdfRadar" alt="Profil sensoriel">
          </div>
          <div class="pdf-aromas">
            <h2>Ar√¥mes</h2>
            <div id="pdfAromas" class="chips"></div>
          </div>
        </div>
        <div class="pdf-right">
          <h2>Notation</h2>
          <div id="pdfNoteSections" class="pdf-sections"></div>
          <div class="pdf-total"><strong>Total :</strong> <span id="pdfTotal"></span></div>
        </div>
      </section>
    </div>
  </div>

  <!-- Overlay de progression PDF -->
  <div id="exportOverlay" class="export-overlay" aria-hidden="true">
    <div class="export-panel" role="status" aria-live="polite">
      <div class="export-header">
        <div class="export-icon">
          <span>üñ®</span>
        </div>
        <div>
          <h2 class="export-title">G√©n√©ration du PDF‚Ä¶</h2>
          <p class="export-subtitle">Nous pr√©parons une fiche nette et pr√™te √† √™tre partag√©e.</p>
        </div>
      </div>
      <div class="export-progress">
        <div class="export-progress-bar">
          <div class="export-progress-fill" id="exportProgressFill"></div>
        </div>
        <div class="export-progress-meta">
          <span id="exportProgressLabel">Pr√©paration de la fiche‚Ä¶</span>
          <span class="export-progress-value" id="exportProgressValue">0%</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      'use strict';

      // ---------------------- CONSTANTES / CONFIG ----------------------
      const THEME_KEY = 'aromatlas-theme';

      const METRICS = [
        { key: 'douceur', label: 'Douceur' },
        { key: 'fruit', label: 'Fruits' },
        { key: 'bois', label: 'Bois' },
        { key: 'fumee', label: 'Fum√©e' },
        { key: 'epices', label: '√âpices' },
        { key: 'amertume', label: 'Amertume' },
        { key: 'salinite', label: 'Salinit√©' }
      ];

      const SCORE_CATEGORIES = [
        { id: 'attrait', label: 'Attrait visuel', max: 5 },
        { id: 'nezInt', label: 'Intensit√© & complexit√© (nez)', max: 15 },
        { id: 'nezDist', label: 'Distinction des ar√¥mes', max: 10 },
        { id: 'nezEq', label: '√âquilibre des ar√¥mes', max: 10 },
        { id: 'palAlc', label: "Harmonie de l'alcool", max: 5 },
        { id: 'palCorps', label: 'Corps en bouche', max: 5 },
        { id: 'palEq', label: '√âquilibre des saveurs', max: 10 },
        { id: 'palComplex', label: 'Complexit√© des saveurs', max: 10 },
        { id: 'palDist', label: 'Distinction des saveurs', max: 10 },
        { id: 'finLen', label: 'Longueur de la finale', max: 10 },
        { id: 'finQual', label: 'Qualit√© de la finale', max: 10 }
      ];

      // ATLAS et INFO (conserv√©s tels quels)
      const ATLAS = {
        'FRUIT√â': {
          _fam: 'fruite',
          Agrumes: ['citron', 'citron vert', 'orange', 'mandarine', 'pamplemousse'],
          'Fruits tropicaux': ['ananas', 'mangue', 'banane', 'papaye', 'fruit de la passion', 'melon'],
          'Fruits √† p√©pins': ['pomme', 'pomme verte', 'poire', 'coing'],
          'Fruits √† noyau': ['p√™che', 'abricot', 'prune', 'mirabelle'],
          'Baies rouges': ['fraise', 'framboise', 'cassis', 'm√ªre', 'myrtille'],
          'Fruits secs': ['raisin sec', 'pruneau', 'figue s√®che', 'abricot sec', 'dattes']
        },
        FLORAL: {
          _fam: 'floral',
          'Notes florales': ["fleur d'oranger", 'rose', 'bruy√®re', 'g√©ranium', 'lavande', 'violette']
        },
        HERBAC√â: {
          _fam: 'herbace',
          'Notes herbac√©es': ['herbe coup√©e', 'menthe', 'eucalyptus', 'gen√©vrier', 'feuille de tabac', 'foin', 'thym', 'pin']
        },
        C√âR√âALE: {
          _fam: 'cereale',
          Torr√©fi√©: ['biscuit', 'toast', 'caf√©', 'cacao', 'chocolat'],
          Levures: ['pain frais', 'p√¢te lev√©e', 'brioche', 'yaourt/fromage frais']
        },
        'QUEUE DE DISTILLATION': {
          _fam: 'queue',
          'Queue de distillation': ['huile min√©rale', 'cire de bougie / paraffine', 'beurre rance', 'savon', 'm√©tallique', 'cuir', 'sac de jute']
        },
        TOURB√â: {
          _fam: 'tourbe',
          Tourb√©: ['fum√©', 'tourbe', 'terre humide', "mousse d‚Äôarbre", 'm√©dicinal', 'vieux bandage', 'bacon', 'goudron', 'caoutchouc', 'k√©ros√®ne', 'silex', 'poisson / fruits de mer', 'iode', 'algue', 'soufre']
        },
        '√âLEVAGE EN F√õT DE CH√äNE': {
          _fam: 'elevage',
          Bois√©: ['ch√™ne', 'c√®dre', 'bois de santal', 'vanille', 'caramel', 'miel'],
          √âpic√©: ['cannelle', 'girofle', 'gingembre', 'poivre', 'noix de muscade', 'cardamome'],
          Vineux: ['sherry / x√©r√®s', 'mad√®re', 'porto', 'vin rouge', 'sauternes'],
          Noix: ['noix', 'noisette', 'amande', 'noix de coco', 'pralin', 'nougat']
        }
      };

      const INFO = {
        // EXISTANTS
        banane: { classe: 'Esters (ac√©tates)', compos√©s: 'Ac√©tate d‚Äôisoamyle', origine: 'Fermentation longue et chaude favorisant les esters fruit√©s ; reflux doux √† la distillation.', fut: 'F√ªts bourbon 1er remplissage pr√©servent ces esters ; trop d‚Äôextraction peut les estomper.', tips: 'Tr√®s fr√©quent dans certains single malts non tourb√©s.', styles: 'Irish Pot Still, Speyside jeune.' },
        pomme: { classe: 'Esters (hexanoates/ac√©tates)', compos√©s: 'Hexanoate d‚Äô√©thyle, ac√©tate d‚Äô√©thyle', origine: 'Levures produisant acides gras + √©thanol ‚áí esters ; t√™tes larges accentuent l‚Äôac√©tate.', fut: 'Refill bourbon conserve la verdeur.', tips: 'S‚Äôapaise avec l‚Äôoxydation ; revient avec un trait d‚Äôeau.', styles: 'Lowlands, Speyside l√©gers.' },
        poire: { classe: 'Esters', compos√©s: 'Ac√©tate d‚Äôhexyle, butyrate d‚Äô√©thyle', origine: 'Fermentation √† basse T¬∞, levures tr√®s est√©rifiantes.', fut: 'Refill bourbon ; certains vins doux renforcent la poire.', tips: 'Tr√®s volatil : ressenti surtout au nez.', styles: 'Speyside, Irish' },
        ananas: { classe: 'Esters', compos√©s: 'Butyrate/hexanoate d‚Äô√©thyle', origine: 'Fermentation riche en acides gras ; distillation avec reflux.', fut: 'Bourbon & ex-rum finish amplifient.', tips: 'Avec noix de coco (lactones) ‚áí ‚Äúpina colada‚Äù.', styles: 'Highlands fruit√©s' },
        citron: { classe: 'Terp√®nes / Ald√©hydes', compos√©s: 'Limon√®ne, citral', origine: 'Cong√©n√®res l√©gers capt√©s en t√™tes ; distillation propre.', fut: 'Refill/fort toast pour garder la vivacit√©.', tips: 'Parfois avec ‚Äúpierre √† fusil‚Äù.', styles: 'Maritime, Highlands' },
        lavande: { classe: 'Terp√®nes', compos√©s: 'Linalol', origine: 'Fermentation ‚Äúpropre‚Äù, distillation douce.', fut: 'Refill bourbon, sherry masque souvent ces notes.', tips: 'Fragile √† l‚Äôoxydation en verre.', styles: 'Speyside' },
        menthe: { classe: 'Terp√®nes / Ph√©nols l√©gers', compos√©s: 'Menthol, eucalyptol', origine: 'Reflux + coupe serr√©e.', fut: 'American oak ‚Üí ‚Äúmenthe-chocolat‚Äù avec cacao/furfural.', tips: 'Sensation fra√Æche.', styles: 'Bourbon cask' },
        chocolat: { classe: 'Furannes / Pyrazines', compos√©s: '5-M√©thylfurfural, pyrazines', origine: 'Toast/char √©lev√© ; Maillard des douelles.', fut: 'American oak fortement bousin√© ; rechar/STR.', tips: 'Souvent avec caf√©/cacao/biscuit.', styles: 'Sherry butt, STR' },
        biscuit: { classe: 'Maillard', compos√©s: 'Maltol, cyclot√®ne', origine: 'Kilning/concassage ; distillation peu r√©ductrice.', fut: 'Bourbon cask, toasts moyens.', tips: 'Texture malt√©e.', styles: 'Highlands' },
        fum√©: { classe: 'Ph√©nols', compos√©s: 'Ga√Øacol, cr√©sols, syringol', origine: 'Malt s√©ch√© √† la tourbe ; ppm + coupe ‚Äúc≈ìur‚Äù = intensit√©.', fut: 'Rechar ‚Üí fum√©-sucr√© ; refill att√©nue.', tips: 'Fum√©e s√®che (ga√Øacol) vs m√©dicinal (p-cr√©sol).', styles: 'Islay, Orkney' },
        tourbe: { classe: 'Ph√©nols / Terp√®nes', compos√©s: 'Cr√©sols, ph√©nol, 4-√©thylga√Øacol', origine: 'Kilning tourb√© ; distillation courte/huileuse.', fut: 'Refill pour puret√© ; sherry = tourbe ‚Äúgourmande‚Äù.', tips: 'Persistance r√©tro-olfactive longue.', styles: 'Islay, peated Highlands' },
        m√©dicinal: { classe: 'Ph√©nols', compos√©s: 'p-Cr√©sol, ga√Øacol', origine: 'Tourbe c√¥ti√®re + worm tub ‚áí notes lourdes.', fut: 'Refill maintient l‚Äôaspect h√¥pital ; sherry arrondit.', tips: 'Souvent indice de coupe l√©g√®rement basse.', styles: 'South Islay' },
        vanille: { classe: 'Ald√©hydes ph√©noliques', compos√©s: 'Vanilline', origine: 'D√©gradation lignine (chauffe du ch√™ne).', fut: 'Quercus alba 1er remplissage = boost vanille.', tips: 'Adoucit et arrondit.', styles: 'Bourbon cask & bourbon' },
        caramel: { classe: 'Furannes', compos√©s: 'Furfural, HMF', origine: 'Toast/char ; Maillard des sucres.', fut: 'Rechar/char √©lev√©.', tips: 'Peut virer ‚Äúbr√ªl√©‚Äù si sur-extraction.', styles: 'Bourbon & sherry' },
        'noix de coco': { classe: 'Lactones', compos√©s: 'Œ≤-methyl-Œ≥-octalactone (cis/trans)', origine: 'Ch√™ne am√©ricain riche en lactones.', fut: 'Bourbon 1er remplissage = coco/cr√®me.', tips: 'Avec ananas ‚áí pina colada.', styles: 'Bourbon cask' },
        cannelle: { classe: 'Ald√©hydes / Ph√©nols √©pic√©s', compos√©s: 'Cinnamald√©hyde, eug√©nol', origine: 'Ch√™ne europ√©en + toast mod√©r√©.', fut: 'Sherry butt/hogshead europ√©ens.', tips: '√âpice s√®che en finale.', styles: 'Sherry cask' },
        noix: { classe: 'Ald√©hydes oxydatifs', compos√©s: 'Ac√©tald√©hyde, sotolon', origine: 'Maturation oxydative (sherry) ; long vieillissement.', fut: 'Oloroso/PX ‚áí fruits secs & noix.', tips: 'Rancio si tr√®s √¢g√©.', styles: 'Sherry matured' },

        // AJOUTS (tout ATLAS manquant)
        'citron vert': { classe: 'Terp√®nes / Ald√©hydes', compos√©s: 'Limon√®ne, citral (g√©ranial/n√©ral)', origine: 'Cong√©n√®res tr√®s volatils capt√©s en t√™tes de distillation ; fermentation ‚Äúpropre‚Äù et reflux mod√©r√© favorisent la nettet√©.', fut: 'Refill bourbon ou toast l√©ger pour pr√©server la fra√Æcheur ; f√ªts tr√®s extractifs l‚Äôestompent.', tips: 'Plus vif et ‚Äútranchant‚Äù que citron ; souvent per√ßu d√®s l‚Äôouverture.', styles: 'Highlands maritimes, Lowlands l√©gers.' },
        orange: { classe: 'Terp√®nes / Esters l√©gers', compos√©s: 'd-Limon√®ne, ac√©tate d‚Äôhexyle', origine: 'Fermentations nettes + coupe plut√¥t haute (t√™tes) ; oxydation douce ‚Üí √©corce d‚Äôorange/confite.', fut: 'Sherry/porto ‚Üí orange confite ; bourbon refill ‚Üí zestes frais.', tips: 'Souvent avec miel/vanille en bouche.', styles: 'Highlands, Speyside doux.' },
        mandarine: { classe: 'Terp√®nes', compos√©s: 'Limon√®ne, Œ≥-terpin√®ne', origine: 'Distillation propre avec forte proportion de compos√©s de t√™te ; fermentation √† faible soufre.', fut: 'Bourbon 1er remplissage pour le c√¥t√© juteux ; refill pour plus de finesse.', tips: 'Plus douce et sucr√©e que l‚Äôorange.', styles: 'Speyside jeune, Irish pot still l√©ger.' },
        pamplemousse: { classe: 'Terp√®nes / C√©tone sesquiterp√©nique', compos√©s: 'Nootkatone, limon√®ne', origine: 'Compos√©s de t√™te + oxydation contr√¥l√©e cr√©ent l‚Äôamertume typique.', fut: 'Refill (peu d‚Äôextraction) pour garder l‚Äôamertume fra√Æche.', tips: 'Peut tirer vers ‚Äúzeste amer‚Äù en finale.', styles: 'C√¥tiers, Highlands secs.' },

        mangue: { classe: 'Esters d‚Äôacides gras', compos√©s: 'Butyrate d‚Äô√©thyle, caproate d‚Äô√©thyle', origine: 'Fermentation riche et longue (levures tr√®s est√©rifiantes) + reflux √† la distillation.', fut: 'Bourbon 1er remplissage, ex-rum finish ‚Üí mangue juteuse.', tips: 'Souvent accompagn√©e de p√™che/abricot.', styles: 'Highlands fruit√©s, quelques Irish.' },
        papaye: { classe: 'Esters l√©gers', compos√©s: 'Butyrate d‚Äô√©thyle, hexanoate d‚Äô√©thyle', origine: 'Fermentation chaude et nutritive ; coupes propres pour garder la note exotique.', fut: 'Bourbon doux ; f√ªts tr√®s oxydatifs l‚Äôeffacent.', tips: 'Ar√¥me surtout au nez, tr√®s volatil.', styles: 'Malts jeunes et non tourb√©s.' },
        'fruit de la passion': { classe: 'Esters / traces de thiols', compos√©s: 'Ac√©tate/Butyrate d‚Äô√©thyle, traces de 3-MH/3-MHA', origine: 'Fermentation expressive ; distillation avec bon reflux.', fut: 'Bourbon neutre ou ex-vin blanc doux pour le c√¥t√© tropical.', tips: 'Souvent per√ßu comme ‚Äútropical acidul√©‚Äù.', styles: 'Highlands doux, certaines finitions vin.' },
        melon: { classe: 'Esters / Alcools ¬´ verts ¬ª', compos√©s: 'Hexanol, ac√©tate d‚Äôhexyle', origine: 'Fermentation propre ; coupes hautes pour les ar√¥mes ‚Äúverts‚Äù.', fut: 'Refill bourbon pour conserver la d√©licatesse.', tips: 'Peut rappeler melon miel/cantaloup.', styles: 'Speyside l√©ger.' },

        'pomme verte': { classe: 'Esters (ac√©tate/caproate)', compos√©s: 'Ac√©tate d‚Äô√©thyle, hexanoate d‚Äô√©thyle', origine: 'Levures produisant acides gras + coupes hautes (t√™tes larges).', fut: 'Refill bourbon pour garder la verdeur croquante.', tips: 'Tendance √† s‚Äôatt√©nuer avec l‚Äôoxydation en verre.', styles: 'Lowlands, Speyside.' },
        coing: { classe: 'Esters / Ald√©hydes oxydatifs', compos√©s: 'Hexanoate d‚Äô√©thyle, sotolon (trace)', origine: '√âvolution fruit√©e ‚Üí confite avec l‚Äô√¢ge (oxydation lente).', fut: 'Sherry/Oloroso pour p√¢te de coing ; bourbon refill pour coing frais.', tips: 'Souvent avec miel/√©pices douces.', styles: 'Sherry matured √¢g√©s, Irish.' },

        p√™che: { classe: 'Esters d‚Äôacides gras', compos√©s: 'Octanoate d‚Äô√©thyle, butyrate d‚Äô√©thyle, Œ¥-d√©calactone', origine: 'Fermentation riche ; reflux mod√©r√© pour douceur juteuse.', fut: 'Bourbon 1er remplissage ‚Üí p√™che m√ªre ; sherry ‚Üí p√™che confite.', tips: 'Tr√®s fr√©quent dans malts fruit√©s non tourb√©s.', styles: 'Highlands, Speyside.' },
        abricot: { classe: 'Esters / Lactones', compos√©s: 'Octanoate d‚Äô√©thyle, Œ¥-d√©calactone', origine: 'Fermentation expressive + distillation propre.', fut: 'Bourbon (frais) ; Oloroso (abricot sec/confit).', tips: 'Volatil, surtout au nez.', styles: 'Speyside fruit√©.' },
        prune: { classe: 'Oxydation / Esters lourds', compos√©s: 'Sotolon, √©thyl lactate', origine: 'Vieillissement prolong√© et/ou sherry riche.', fut: 'Oloroso/PX ‚Üí pruneau/prune confite.', tips: 'Souvent avec cacao/noix.', styles: 'Sherry matured √¢g√©s.' },
        mirabelle: { classe: 'Esters / Lactones', compos√©s: 'Octanoate d‚Äô√©thyle, Œ¥-d√©calactone', origine: 'Fermentation fruit√©e ; coupes nettes.', fut: 'Bourbon neutre pour la d√©licatesse.', tips: 'Entre abricot et pomme jaune.', styles: 'Malts doux, parfois continentaux.' },

        fraise: { classe: 'Esters / Furaneones', compos√©s: 'Butyrate d‚Äô√©thyle, furaneol', origine: 'Fermentations tr√®s est√©rifiantes ; distillation propre.', fut: 'Finitions vin rouge/porto ‚Üí fraise confite.', tips: 'Note de t√™te sucr√©e.', styles: 'Finishes ‚Äúwine cask‚Äù, Speyside jeunes.' },
        framboise: { classe: 'C√©tones aromatiques / Esters', compos√©s: 'Frambinone (raspberry ketone), ac√©tate d‚Äôhexyle', origine: 'Fermentation nette ; peu d‚Äôinfluence de queue.', fut: 'Refill ou vin rouge l√©ger.', tips: 'Souvent avec p√©tales de rose.', styles: 'Malts l√©gers, finitions vin.' },
        cassis: { classe: 'Esters / Thiols traces', compos√©s: 'Œ≤-damasc√©none, 4MMP (traces)', origine: 'Fermentation expressive ; √©levage mod√©r√©.', fut: 'Vin rouge/sherry pour cassis confit.', tips: 'Parfois ‚Äúribena‚Äù au nez.', styles: 'Finishes vin rouge, sherry fruit√©.' },
        'm√ªre': { classe: 'Esters / Norisopr√©no√Ødes', compos√©s: 'Ethyl butyrate, Œ≤-damasc√©none', origine: 'Fermentation riche ; coupes nettes.', fut: 'Vin rouge/porto.', tips: 'Donne un fondu de fruits noirs.', styles: 'Highlands/Speyside en finish.' },
        myrtille: { classe: 'Esters / Norisopr√©no√Ødes', compos√©s: 'Ethyl caproate, Œ≤-ionone (trace)', origine: 'Fermentation expressive ; distillation ‚Äúpropre‚Äù.', fut: 'Refill pour garder le c√¥t√© bleuet.', tips: 'Nuance plus sombre que m√ªre.', styles: 'Malts l√©gers.' },

        'raisin sec': { classe: 'Ald√©hydes oxydatifs / Lactones', compos√©s: 'Sotolon, furfural', origine: 'Maturation oxydative prolong√©e (sherry, vins doux).', fut: 'Oloroso/PX ‚Üí raisins secs prononc√©s.', tips: 'Souvent avec noix/caramel.', styles: 'Sherry matured.' },
        pruneau: { classe: 'Ald√©hydes / Esters lourds', compos√©s: 'Sotolon, √©thyl lactate', origine: 'Vieillissement long en f√ªts oxydatifs.', fut: 'PX/Oloroso.', tips: 'Texture sirupeuse en bouche.', styles: 'Malts tr√®s √¢g√©s, sherry.' },
        'figue s√®che': { classe: 'Oxydation / Maillard', compos√©s: 'Furfural, HMF, sotolon', origine: 'Interaction bois-alcool + oxyg√®ne (longue maturation).', fut: 'Sherry (oloroso/PX).', tips: 'Va souvent avec dattes/miel.', styles: 'Sherry matured.' },
        'abricot sec': { classe: 'Esters / Oxydation', compos√©s: 'Octanoate d‚Äô√©thyle, sotolon', origine: '√âvolution des esters en √©levage oxydatif.', fut: 'Oloroso, parfois Sauternes.', tips: 'Souvent avec amande.', styles: 'Finitions vins doux.' },
        dattes: { classe: 'Oxydation / Caram√©lisation', compos√©s: 'Sotolon, HMF', origine: 'Vieillissement prolong√© en f√ªts tr√®s actifs.', fut: 'PX / vins doux naturels.', tips: 'Gourmandise ‚Äúp√¢te de dattes‚Äù.', styles: 'Sherry tr√®s marqu√©.' },

        "fleur d'oranger": { classe: 'Terp√®nes', compos√©s: 'Linalol, n√©rol, g√©raniol', origine: 'Fermentation ‚Äúpropre‚Äù ; coupes hautes.', fut: 'Refill bourbon ; sherry peut masquer.', tips: 'Florale + zeste d‚Äôagrume.', styles: 'Speyside, Irish l√©gers.' },
        rose: { classe: 'Alcool/ester aromatique', compos√©s: 'Alcool ph√©nyl√©thylique, ac√©tate de ph√©nyl√©thyle', origine: 'M√©tabolites de levures ; distillation douce.', fut: 'Bourbon neutre ; √©viter les toasts lourds.', tips: 'Avec miel/litchi parfois.', styles: 'Speyside d√©licat.' },
        bruy√®re: { classe: 'Notes florales/miell√©es', compos√©s: 'Sotolon (trace), ph√©nols l√©gers', origine: 'Vieillissement temp√©r√© ; chais humides.', fut: 'Sherry doux ou bourbon ancien.', tips: 'Souvent associ√©e aux malts c√¥tiers d‚ÄôOrkney.', styles: 'Highlands/Orkney.' },
        g√©ranium: { classe: 'Terp√®nes', compos√©s: 'G√©raniol, citronellol', origine: 'Fermentation nette ; coupes hautes.', fut: 'Refill pour conserver la d√©licatesse.', tips: 'Peut virer savonneux si trop extrait.', styles: 'Malts tr√®s l√©gers.' },
        violette: { classe: 'Norisopr√©no√Ødes', compos√©s: 'Ionones (Œ±/Œ≤-ionone)', origine: 'Traces issues de la fermentation et du vieillissement.', fut: 'Bourbon neutre ; √©viter rechar fort.', tips: 'Nuance poudr√©e tr√®s subtile.', styles: 'Speyside √©l√©gant.' },

        'herbe coup√©e': { classe: 'Alcools ¬´ verts ¬ª', compos√©s: 'cis-3-hex√©nol, cis-3-hex√©nyl ac√©tate', origine: 'Fermentation courte ; coupes tr√®s hautes (t√™tes).', fut: 'Refill/bois peu actif.', tips: 'Donne fra√Æcheur v√©g√©tale au nez.', styles: 'Lowlands, malts jeunes.' },
        eucalyptus: { classe: 'Terp√®nes / Oxydation', compos√©s: '1,8-cin√©ole (eucalyptol)', origine: 'Distillation √† fort reflux ; coupe serr√©e.', fut: 'Bourbon toast√© moyen.', tips: 'Fra√Æcheur camphr√©e.', styles: 'Bourbon cask, quelques tourb√©s.' },
        gen√©vrier: { classe: 'Terp√®nes r√©sineux', compos√©s: 'Œ±-pin√®ne, sabin√®ne', origine: 'Cong√©n√®res r√©sineux capt√©s en t√™tes.', fut: 'Refill ; bois neuf att√©nue.', tips: 'Rappelle le gin (l√©g√®rement).', styles: 'Malts secs, parfois rye.' },
        'feuille de tabac': { classe: 'Ph√©nols / Pyrazines', compos√©s: 'Pyridines, pyrazines, ph√©nols m√©thoxyl√©s', origine: 'Queue l√©g√®re + maturation oxydative.', fut: 'Sherry/Oloroso, vieux f√ªts.', tips: 'Souvent avec cuir/bo√Æte √† cigare.', styles: 'Sherry √¢g√©s.' },
        foin: { classe: 'Lactones / Coumarine', compos√©s: 'Coumarine, vanilline (trace)', origine: 'Oxydation douce durant l‚Äô√©levage.', fut: 'Refill/bourbon ancien.', tips: 'Herbac√© sec, miel l√©ger.', styles: 'Highlands, Speyside.' },
        thym: { classe: 'Terp√®nes', compos√©s: 'Thymol, carvacrol', origine: 'Coupe propre + reflux ; peu de queue.', fut: 'Refill ; bois neuf peut masquer.', tips: 'Parfois avec pin/romarin.', styles: 'Malts herbac√©s.' },
        pin: { classe: 'Terp√®nes r√©sineux', compos√©s: 'Œ±/Œ≤-pin√®ne', origine: 'Compos√©s de t√™te ; distillation propre.', fut: 'Refill ; ch√™ne europ√©en peut ajouter ‚Äúc√®dre‚Äù.', tips: 'Sensation r√©sineuse fra√Æche.', styles: 'C√¥tiers/herbac√©s.' },

        toast: { classe: 'Produits de Maillard', compos√©s: 'Maltol, cyclot√®ne', origine: 'S√©chage du malt + toast des douelles.', fut: 'Toasts moyens √† forts (bourbon, rechar).', tips: 'Entre biscuit et pain grill√©.', styles: 'Highlands, bourbons.' },
        caf√©: { classe: 'Furannes / Pyrazines', compos√©s: '5-m√©thylfurfural, pyrazines torr√©fi√©es', origine: 'Bois fortement bousin√© (char), Maillard.', fut: 'Rechar/STR, ch√™ne neuf.', tips: 'Souvent avec cacao/chocolat.', styles: 'Sherry/STR.' },
        cacao: { classe: 'Furannes / Pyrazines', compos√©s: 'Furfural, 2-furfurylthiol (trace)', origine: 'Toast/char √©lev√© ; Maillard du bois.', fut: 'Rechar, ch√™ne neuf.', tips: 'Amertume √©l√©gante en finale.', styles: 'Bourbon & sherry.' },

        'pain frais': { classe: 'Esters / Ald√©hydes l√©gers', compos√©s: 'Ac√©tate d‚Äô√©thyle, ac√©tald√©hyde', origine: 'Fermentation active ; levures ‚Äúboulang√®res‚Äù.', fut: 'Refill pour conserver la brioche/pain.', tips: 'Tr√®s marqu√© sur new make.', styles: 'Irish pot still, Speyside jeune.' },
        'p√¢te lev√©e': { classe: 'Esters / Diac√©tyle (trace)', compos√©s: 'Ac√©tate d‚Äôhexyle, diac√©tyle', origine: 'Fermentation riche ; repos de mo√ªt.', fut: 'Refill ; sherry masque.', tips: 'Impression de boulange.', styles: 'Malts tr√®s jeunes.' },
        brioche: { classe: 'Esters lactiques', compos√©s: '√âthyl lactate, ac√©tate d‚Äôhexyle', origine: 'Fermentation + √©levage doux (peu d‚Äôoxydation).', fut: 'Bourbon refill ‚Üí brioch√© sucr√©.', tips: 'Souvent avec vanille.', styles: 'Speyside, Irish.' },
        'yaourt/fromage frais': { classe: 'Acides/esters lactiques', compos√©s: 'Acide lactique, √©thyl lactate', origine: 'Bact√©ries lactiques/levures ; ferments laitiers dans le mo√ªt.', fut: 'Refill ; bois neuf att√©nue.', tips: 'Acidit√© cr√©meuse agr√©able.', styles: 'Malts fermiers, quelques craft.' },

        'huile min√©rale': { classe: 'Alcools/esters lourds (queue)', compos√©s: 'Acides gras C8‚ÄìC12, alcools sup√©rieurs', origine: 'Coupes basses (queue) ou distillation tr√®s huileuse.', fut: 'Refill long r√©duit la sensation ; rechar peut la ‚Äúnettoyer‚Äù.', tips: 'Peut rappeler ‚Äúparaffine/min√©ral‚Äù.', styles: 'Alambics √† worm tub, styles ‚Äúwaxy‚Äù.' },
        'cire de bougie / paraffine': { classe: 'Esters/alcools √† longue cha√Æne', compos√©s: 'Esters cireux C18+, alcools gras', origine: 'Distillats ‚Äúwaxy‚Äù + maturation mod√©r√©e.', fut: 'Bourbon refill ; trop d‚Äôextraction la masque.', tips: 'Signature de certaines distilleries (ex. style Clynelish).', styles: 'Highlands cireux.' },
        'beurre rance': { classe: 'Acides gras volatils', compos√©s: 'Acide butyrique, isobutyrique', origine: 'Queue/contamination lactique ; vieillissement trop chaud.', fut: 'Refill long ou recoupe stricte pour l‚Äô√©viter.', tips: 'D√©faut au-del√† d‚Äôun seuil.', styles: 'Occasionnel, new make imparfait.' },
        savon: { classe: 'Saponification', compos√©s: 'Sels d‚Äôacides gras, acides gras libres', origine: 'R√©action acides gras/ions (eau dure) ; exc√®s de queue.', fut: 'Filtration/purge ; √©viter f√ªts contamin√©s.', tips: 'D√©faut net au palais.', styles: '‚Äî' },
        m√©tallique: { classe: 'Ions m√©talliques / Ald√©hydes', compos√©s: 'Fer/Cuivre (traces), ald√©hydes r√©actifs', origine: 'Contact m√©tal/coupe basse ; eau de r√©duction riche en Fe.', fut: 'Aucun f√ªt ne ‚Äúcorrige‚Äù totalement ; a√©ration peut aider.', tips: 'Sensation sang/monnaie.', styles: '‚Äî' },
        cuir: { classe: 'Tannins / Ph√©nols oxyd√©s', compos√©s: 'Tannins hydrolysables, ald√©hydes ph√©noliques', origine: 'Extraction de ch√™ne europ√©en + oxydation longue.', fut: 'Sherry/Oloroso, vieux f√ªts.', tips: 'Souvent avec tabac/bo√Æte √† cigare.', styles: 'Sherry √¢g√©s.' },
        'sac de jute': { classe: 'Ph√©nols / Ald√©hydes', compos√©s: 'G√©osmine (trace), ald√©hydes ‚Äúpoussi√©reux‚Äù', origine: 'Vieux f√ªts (sherry) ou stockage humide.', fut: 'F√ªts tr√®s anciens ; refill propre pour l‚Äô√©viter.', tips: 'Note ‚Äúhessian‚Äù typique de certains lots.', styles: 'Sherry traditionnels.' },

        'terre humide': { classe: 'Compos√©s terreux', compos√©s: 'G√©osmine, 2-m√©thylisoborn√©ol (trace)', origine: 'Tourbe + chais humides ; coupe un peu basse.', fut: 'Refill pour garder la puret√© de la tourbe.', tips: 'Souvent avec mousse d‚Äôarbre.', styles: 'Islay, Highlands tourb√©s.' },
        "mousse d‚Äôarbre": { classe: 'Terp√®nes/Ph√©nols', compos√©s: 'Ionones (trace), ph√©nols l√©gers', origine: 'Tourbe + maturation humide.', fut: 'Refill ; sherry l‚Äôadoucit.', tips: 'Rappelle sous-bois humide.', styles: 'C√¥tiers tourb√©s.' },
        'vieux bandage': { classe: 'Ph√©nols', compos√©s: 'p-cr√©sol, ga√Øacol', origine: 'Tourbe c√¥ti√®re + coupe basse.', fut: 'Refill maintient l‚Äôaspect m√©dicinal.', tips: 'Marqueurs typiques de certains Islay.', styles: 'Sud Islay.' },
        bacon: { classe: 'Ph√©nols & ph√©nols alkyl√©s', compos√©s: '4-√©thylga√Øacol, 4-√©thylph√©nol', origine: 'Combustion de tourbe/char ; distillation huileuse.', fut: 'Rechar ‚Üí fum√©-sucr√© ‚Äúbacon‚Äù.', tips: 'Souvent per√ßu au nez + r√©tro.', styles: 'Islay, peated Highlands.' },
        goudron: { classe: 'Ph√©nols lourds', compos√©s: 'Cr√©sols, naphtols (trace)', origine: 'Tourbe riche en r√©sines + coupe basse.', fut: 'Refill ; sherry arrondit.', tips: 'Fum√© sombre et collant.', styles: 'Islay puissants.' },
        caoutchouc: { classe: 'Soufr√©s / Ph√©nols', compos√©s: 'Thiols, ph√©nols m√©thyl√©s', origine: 'R√©duction/soufre en f√ªts de sherry mal pr√©par√©s ou coupes basses.', fut: 'Conditionnement soign√© ; a√©ration att√©nue.', tips: 'Peut √™tre d√©faut si dominant.', styles: 'Certains sherry casks.' },
        'k√©ros√®ne': { classe: 'Hydrocarbures aromatiques (trace) / R√©duction', compos√©s: 'Compos√©s aromatiques r√©duits, ph√©nols lourds', origine: 'Tourbe intense + r√©duction ; coupes basses.', fut: 'Refill pour limiter, rechar sucrant.', tips: 'Note extr√™me, rare.', styles: 'Islay tr√®s tourb√©s.' },
        silex: { classe: 'Soufr√©s r√©duits', compos√©s: 'H‚ÇÇS/thiols (traces) ‚Üí impression ‚Äúpierre √† fusil‚Äù', origine: 'R√©duction en f√ªt/fermentation ; distillation tr√®s propre.', fut: 'Refill/bois peu actif pour le garder subtil.', tips: 'Souvent avec citron/zeste.', styles: 'Maritime, Highlands.' },
        'poisson / fruits de mer': { classe: 'Soufr√©s / Ph√©nols marins', compos√©s: 'DMS (dim√©thylsulfure), ph√©nols iod√©s (per√ßus)', origine: 'Tourbe c√¥ti√®re + maturation en chai marin.', fut: 'Refill ‚Üí profil marin net.', tips: '‚ÄúCoquillage/hu√Ætre‚Äù au nez.', styles: 'Islay, √Æles.' },
        iode: { classe: 'Perception ph√©nolique marine', compos√©s: 'p-cr√©sol et ph√©nols associ√©s (per√ßus iod√©s)', origine: 'Tourbe c√¥ti√®re ; environnement salin.', fut: 'Refill ; sherry adoucit.', tips: 'Signature de malts marins.', styles: 'Islay, √Æles.' },
        algue: { classe: 'Ph√©nols / Terp√®nes marins', compos√©s: 'Ph√©nols iod√©s, sesquiterp√®nes d‚Äôalgues (trace)', origine: 'Tourbe c√¥ti√®re + chais au bord de mer.', fut: 'Refill pour salinit√©/algue nette.', tips: 'Parfois ‚Äúnori/kelp‚Äù.', styles: 'Islay, Campbeltown.' },
        soufre: { classe: 'Compos√©s soufr√©s r√©duits', compos√©s: 'H‚ÇÇS, mercaptans (trace)', origine: 'R√©duction/assainissement au soufre de f√ªts ; fermentation r√©ductrice.', fut: 'A√©ration/re-racking ; sherry mal rinc√© l‚Äôaccentue.', tips: 'Peut virer allumette/caoutchouc.', styles: 'Cas ponctuels.' },

        ch√™ne: { classe: 'Lactones / Tannins / Ald√©hydes', compos√©s: 'Œ≤-methyl-Œ≥-octalactone, vanilline, ellagitannins', origine: 'Extraction du bois (esp√®ce, toast, chauffe).', fut: 'Quercus alba ‚Üí coco/vanille ; Quercus robur ‚Üí tanins/√©pices.', tips: 'Structure, astringence et douceur.', styles: 'Tous selon f√ªt.' },
        c√®dre: { classe: 'Sesquiterp√®nes bois√©s', compos√©s: 'C√©drol, thujops√®ne', origine: 'Ch√™ne europ√©en tr√®s toast√©/√¢g√©.', fut: 'Sherry europ√©en ; long √©levage.', tips: 'Bo√Æte √† cigare, √©pices s√®ches.', styles: 'Sherry √¢g√©s.' },
        'bois de santal': { classe: 'Sesquiterp√®nes', compos√©s: 'Santalol (Œ±/Œ≤)', origine: '√âvolution des lactones + compos√©s bois√©s.', fut: 'Ch√™ne europ√©en, long √©levage.', tips: 'Cr√©meux, enveloppant.', styles: 'Malts tr√®s √¢g√©s.' },
        miel: { classe: 'Esters aromatiques / Norisopr√©no√Ødes', compos√©s: 'Ac√©tate de ph√©nyl√©thyle, Œ≤-damasc√©none', origine: 'Oxydation douce + esters floraux.', fut: 'Sherry doux, bourbon 1er remplissage.', tips: 'Souvent avec cire/bruy√®re.', styles: 'Speyside, Orkney.' },
        girofle: { classe: 'Ph√©nols √©pic√©s', compos√©s: 'Eug√©nol', origine: 'Extraction du ch√™ne (toast mod√©r√©/fort).', fut: 'Ch√™ne europ√©en/sherry.', tips: 'Picotement √©pic√© en finale.', styles: 'Sherry casks.' },
        gingembre: { classe: 'C√©tones √©pic√©es', compos√©s: 'Zing√©rone', origine: 'Toast/char ; oxydation des sucres du bois.', fut: 'Rechar/STR.', tips: 'Chaleur √©pic√©e, bouche s√®che.', styles: 'Bourbon & sherry.' },
        poivre: { classe: 'Ph√©nols/terp√®nes √©pic√©s', compos√©s: 'Eug√©nol, sabin√®ne (perception poivr√©e)', origine: 'Extraction du ch√™ne + alcool fort.', fut: 'Ch√™ne neuf/fortement toast√©.', tips: 'Plus tactile qu‚Äôaromatique.', styles: 'Rye/bourbon, certains malts bois√©s.' },
        'noix de muscade': { classe: 'Ph√©nylpropano√Ødes', compos√©s: 'Myristicine, safrole (trace)', origine: 'Ch√™ne europ√©en bien toast√©.', fut: 'Sherry europ√©en.', tips: '√âpice douce et chaude.', styles: 'Sherry casks.' },
        cardamome: { classe: 'Terp√®nes √©pic√©s', compos√©s: '1,8-cin√©ole, terpinyl ac√©tate', origine: 'Interaction esters/terp√®nes du bois.', fut: 'F√ªts actifs (neuf/rechar).', tips: 'Fra√Æcheur √©pic√©e menthol√©e.', styles: 'Bourbon actifs.' },

        'sherry / x√©r√®s': { classe: 'Oxydation / Esters', compos√©s: 'Sotolon, ac√©tald√©hyde, √©thyl lactate', origine: 'Transfert du vin + oxydation en f√ªt.', fut: 'Oloroso/PX/Amontillado.', tips: 'Fruits secs, noix, √©pices.', styles: 'Sherry matured/finish.' },
        mad√®re: { classe: 'Oxydation / Caram√©lisation', compos√©s: 'HMF, sotolon', origine: 'F√ªts ex-Mad√®re (chauffage/mad√©risation).', fut: 'Casks ex-Madeira.', tips: 'Zeste d‚Äôorange, caramel, rancio.', styles: 'Finishes Mad√®re.' },
        porto: { classe: 'Esters fruit√©s / Tanins', compos√©s: 'Esters de fruits rouges, ac√©tate d‚Äô√©thyle', origine: 'F√ªts ex-Porto (Ruby/Tawny).', fut: 'Port pipes.', tips: 'Fruits rouges, chocolat au lait.', styles: 'Finishes port cask.' },
        'vin rouge': { classe: 'Tanins / Esters', compos√©s: 'Tanins condens√©s, Œ≤-damasc√©none', origine: 'Transfert de vin + extraction du ch√™ne.', fut: 'Barriques de Bordeaux/Bourgogne.', tips: 'Baies rouges, structure tannique.', styles: 'Wine cask finishes.' },
        sauternes: { classe: 'Oxydation douce / Botrytisation', compos√©s: 'Sotolon, ac√©tate de ph√©nyl√©thyle, miel', origine: 'F√ªts ex-Sauternes (vins botrytis√©s).', fut: 'Casks de Sauternes.', tips: 'Miel/abricot confit.', styles: 'Finishes Sauternes.' },

        noisette: { classe: 'Ald√©hydes oxydatifs', compos√©s: 'Sotolon (faible), furfural', origine: 'Vieillissement oxydatif (sherry).', fut: 'Oloroso/PX.', tips: 'Souvent avec toffee/noix.', styles: 'Sherry matured.' },
        amande: { classe: 'Aromas benzyl√©s', compos√©s: 'Benzald√©hyde', origine: 'Oxydation/interaction bois ; parfois influence de noyaux des vins fortifi√©s.', fut: 'Sherry/PX, vins doux.', tips: 'Peut rappeler massepain.', styles: 'Sherry casks.' },
        pralin: { classe: 'Maillard + Fruits √† coque', compos√©s: 'Furfural, HMF, lactones', origine: 'Caram√©lisation du bois + notes noix/noisette.', fut: 'Rechar/bois actif.', tips: 'Gourmand, sucr√©-noisette.', styles: 'Bourbon & sherry.' },
        nougat: { classe: 'Sucre cuit / Lactones', compos√©s: 'HMF, vanilline, lactones', origine: 'Toast du bois + esters lactiques.', fut: 'Bourbon 1er remplissage.', tips: 'Cr√©meux, vanill√©-mielleux.', styles: 'Bourbon cask.' }
      };

      // Liste aplatie pour la recherche
      const FLAT = [];
      Object.entries(ATLAS).forEach(([fam, groups]) => {
        Object.entries(groups).forEach(([grp, items]) => {
          if (grp === '_fam') return;
          items.forEach((label) => {
            FLAT.push({ fam, group: grp, label, path: fam + ' ‚Ä∫ ' + grp });
          });
        });
      });

      const labelToFam = {};
      Object.entries(ATLAS).forEach(([familyName, groups]) => {
        const famCode = groups._fam || familyName.toLowerCase();
        Object.entries(groups).forEach(([grp, items]) => {
          if (grp === '_fam') return;
          items.forEach((lbl) => {
            labelToFam[lbl] = famCode;
          });
        });
      });

      // ---------------------- √âTAT GLOBAL ----------------------
      const state = {
        picks: [],
        metrics: {},
        scores: {}
      };
      METRICS.forEach((m) => (state.metrics[m.key] = 5));
      SCORE_CATEGORIES.forEach((c) => (state.scores[c.id] = 0));

      let radarChart = null;

      const exportUI = {
        overlay: null,
        fill: null,
        label: null,
        value: null,
        timer: null,
        current: 0
      };

      function normalize(str) {
        return (str || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
      }

      // Helper couleurs
      function getThemeTokens(forcedTheme) {
        // Si forcedTheme est d√©fini ('light' ou 'dark'), on renvoie les codes couleurs
        // hardcod√©s pour √©viter d'utiliser getComputedStyle d√©pendant du DOM.
        if (forcedTheme === 'light') {
          return {
            text: '#020617',
            muted: '#6b7280',
            border: 'rgba(148, 163, 184, 0.26)',
            accent: '#2563eb',
            grid: 'rgba(148, 163, 184, 0.35)'
          };
        } else if (forcedTheme === 'dark') {
          return {
            text: '#e5e7eb',
            muted: '#9ca3af',
            border: 'rgba(148, 163, 184, 0.4)',
            accent: '#38bdf8',
            grid: 'rgba(148, 163, 184, 0.35)'
          };
        }

        // Sinon on lit le DOM (live)
        const root = document.documentElement;
        const style = getComputedStyle(root);
        const get = (name, fallback) => {
          const v = style.getPropertyValue(name).trim();
          return v || fallback;
        };
        return {
          text: get('--color-text', '#111827'),
          muted: get('--color-muted', '#6b7280'),
          border: get('--color-border-subtle', 'rgba(148, 163, 184, 0.4)'),
          accent: get('--color-accent', '#2563eb'),
          grid: 'rgba(148, 163, 184, 0.35)'
        };
      }

      // ---------------------- TH√àME (clair/sombre) ----------------------
      function initTheme() {
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const saved = (typeof localStorage !== 'undefined') ? localStorage.getItem(THEME_KEY) : null;
        const initial = saved === 'light' || saved === 'dark' ? saved : (prefersDark ? 'dark' : 'light');
        applyTheme(initial);

        const toggle = document.getElementById('themeToggle');
        if (toggle) {
          toggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme') || initial;
            const next = current === 'dark' ? 'light' : 'dark';
            applyTheme(next);
            try {
              localStorage.setItem(THEME_KEY, next);
            } catch (e) {}
          });
        }

        if (window.matchMedia) {
          window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            const savedAgain = (typeof localStorage !== 'undefined') ? localStorage.getItem(THEME_KEY) : null;
            if (!savedAgain) {
              const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
              applyTheme(isDark ? 'dark' : 'light');
            } else {
              updateThemeToggleIcon(savedAgain);
              updateChartTheme();
            }
          });
        }
      }

      function applyTheme(mode) {
        document.documentElement.setAttribute('data-theme', mode);
        updateThemeToggleIcon(mode);
        updateChartTheme();
      }

      function updateThemeToggleIcon(mode) {
        const btn = document.getElementById('themeToggle');
        if (!btn) return;
        const iconSpan = btn.querySelector('.theme-icon');
        if (!iconSpan) return;
        const isDark = mode === 'dark';
        iconSpan.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
        btn.setAttribute('aria-pressed', isDark ? 'true' : 'false');
      }

      // ---------------------- OVERLAY EXPORT PDF ----------------------
      function initExportOverlay() {
        exportUI.overlay = document.getElementById('exportOverlay');
        exportUI.fill = document.getElementById('exportProgressFill');
        exportUI.label = document.getElementById('exportProgressLabel');
        exportUI.value = document.getElementById('exportProgressValue');
      }

      function startExportProgress() {
        if (!exportUI.overlay) return;
        exportUI.overlay.setAttribute('aria-hidden', 'false');
        exportUI.overlay.classList.add('open');
        document.body.style.overflow = 'hidden';
        exportUI.current = 0;
        if (exportUI.fill) exportUI.fill.style.width = '0%';
        if (exportUI.label) exportUI.label.textContent = 'Pr√©paration de la fiche‚Ä¶';
        if (exportUI.value) exportUI.value.textContent = '0%';

        if (exportUI.timer) {
          clearInterval(exportUI.timer);
          exportUI.timer = null;
        }

        exportUI.timer = setInterval(() => {
          if (exportUI.current >= 88) return;
          exportUI.current += 2;
          if (exportUI.current > 88) exportUI.current = 88;

          if (exportUI.fill) exportUI.fill.style.width = exportUI.current + '%';
          if (exportUI.value) exportUI.value.textContent = exportUI.current + '%';

          if (!exportUI.label) return;
          if (exportUI.current < 25) {
            exportUI.label.textContent = 'Pr√©paration de la fiche‚Ä¶';
          } else if (exportUI.current < 55) {
            exportUI.label.textContent = 'Capture du profil sensoriel‚Ä¶';
          } else if (exportUI.current < 80) {
            exportUI.label.textContent = 'G√©n√©ration du document‚Ä¶';
          } else {
            exportUI.label.textContent = 'Finalisation‚Ä¶';
          }
        }, 260);
      }

      function completeExportProgress(success) {
        if (!exportUI.overlay) return;
        if (exportUI.timer) {
          clearInterval(exportUI.timer);
          exportUI.timer = null;
        }
        exportUI.current = 100;
        if (exportUI.fill) exportUI.fill.style.width = '100%';
        if (exportUI.value) exportUI.value.textContent = '100%';
        if (exportUI.label) {
          exportUI.label.textContent = success
            ? 'PDF pr√™t √† √™tre t√©l√©charg√©.'
            : 'Une erreur est survenue lors de la g√©n√©ration.';
        }
        setTimeout(() => {
          exportUI.overlay.setAttribute('aria-hidden', 'true');
          exportUI.overlay.classList.remove('open');
          document.body.style.overflow = '';
        }, 650);
      }

      // ---------------------- UI DYNAMIQUE ----------------------
      function buildMetrics() {
        const container = document.getElementById('metricControls');
        if (!container) return;
        container.innerHTML = '';
        METRICS.forEach((m) => {
          const row = document.createElement('div');
          row.className = 'metric-row';

          const label = document.createElement('label');
          label.textContent = m.label;
          label.setAttribute('for', 'm-' + m.key);

          const wrap = document.createElement('div');
          wrap.className = 'range-wrap';

          const input = document.createElement('input');
          input.type = 'range';
          input.min = '0';
          input.max = '10';
          input.step = '1';
          input.value = String(state.metrics[m.key]);
          input.id = 'm-' + m.key;

          const output = document.createElement('output');
          output.textContent = String(state.metrics[m.key]);

          wrap.appendChild(input);
          wrap.appendChild(output);
          row.appendChild(label);
          row.appendChild(wrap);
          container.appendChild(row);

          input.addEventListener('input', () => {
            const val = parseInt(input.value, 10) || 0;
            state.metrics[m.key] = val;
            output.textContent = String(val);
            updateChart();
            updatePreview();
          });
        });
      }

      // Nouvelle version ergonomique pour les notes (Sliders + Boutons)
      function buildScores() {
        const container = document.getElementById('scoreControls');
        if (!container) return;
        container.innerHTML = '';

        SCORE_CATEGORIES.forEach((c) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'score-control';

          // En-t√™te : Label + Valeur
          const header = document.createElement('div');
          header.className = 'score-header';
          
          const label = document.createElement('label');
          label.className = 'score-label';
          label.setAttribute('for', 's-' + c.id);
          label.textContent = c.label;

          const valDisplay = document.createElement('div');
          valDisplay.className = 'score-val-display';
          // Cr√©ation du texte de valeur (ex: "8 / 10")
          const valNum = document.createElement('span'); 
          valNum.textContent = '0';
          valNum.style.fontWeight = '700';
          valNum.style.color = 'var(--color-accent)';
          valNum.style.fontSize = '15px';
          
          const valMax = document.createElement('span');
          valMax.textContent = ' / ' + c.max;

          valDisplay.appendChild(valNum);
          valDisplay.appendChild(valMax);

          header.appendChild(label);
          header.appendChild(valDisplay);

          // Contr√¥les : [-] [Slider] [+]
          const controls = document.createElement('div');
          controls.className = 'score-input-wrapper';

          const btnDec = document.createElement('button');
          btnDec.type = 'button';
          btnDec.className = 'score-btn';
          btnDec.textContent = '‚Äì'; // en dash
          btnDec.ariaLabel = "Diminuer la note pour " + c.label;

          const slider = document.createElement('input');
          slider.type = 'range';
          slider.className = 'score-slider';
          slider.min = '0';
          slider.max = String(c.max);
          slider.step = '0.5'; // Pr√©cision √† 0.5 possible
          slider.value = '0';
          slider.id = 's-' + c.id;

          const btnInc = document.createElement('button');
          btnInc.type = 'button';
          btnInc.className = 'score-btn';
          btnInc.textContent = '+';
          btnInc.ariaLabel = "Augmenter la note pour " + c.label;

          controls.appendChild(btnDec);
          controls.appendChild(slider);
          controls.appendChild(btnInc);

          wrapper.appendChild(header);
          wrapper.appendChild(controls);
          container.appendChild(wrapper);

          // Fonction de mise √† jour centralis√©e pour ce champ
          const updateField = (val) => {
            let num = parseFloat(val);
            if (isNaN(num)) num = 0;
            if (num < 0) num = 0;
            if (num > c.max) num = c.max;

            // Mise √† jour Slider
            slider.value = String(num);
            
            // Mise √† jour affichage texte
            valNum.textContent = num;

            // Mise √† jour √©tat global
            state.scores[c.id] = num;

            // Mise √† jour visuelle de la "track" du slider (gradient)
            const pct = (num / c.max) * 100;
            // CSS var dynamic override ou direct style
            slider.style.background = `linear-gradient(to right, var(--color-accent) 0%, var(--color-accent) ${pct}%, rgba(148, 163, 184, 0.2) ${pct}%, rgba(148, 163, 184, 0.2) 100%)`;

            // D√©sactivation des boutons aux limites
            btnDec.disabled = (num <= 0);
            btnInc.disabled = (num >= c.max);

            updateTotal();
            updatePreview();
          };

          // Listeners
          slider.addEventListener('input', (e) => updateField(e.target.value));
          
          btnDec.addEventListener('click', () => {
            let current = parseFloat(slider.value);
            // Pas de 1 ou 0.5 selon pr√©f√©rence (ici 1 pour boutons, slider permet 0.5 si on veut)
            // On reste simple : boutons +/- 1
            updateField(current - 1); 
          });

          btnInc.addEventListener('click', () => {
            let current = parseFloat(slider.value);
            updateField(current + 1);
          });

          // Initialisation visuelle
          updateField(0);
        });
      }

      // ---------------------- CHART RADAR ----------------------
      function initRadarChart() {
        const canvas = document.getElementById('radarChart');
        if (!canvas || !window.Chart) return;
        const ctx = canvas.getContext('2d');
        const theme = getThemeTokens();

        radarChart = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: METRICS.map((m) => m.label),
            datasets: [{
              label: 'Profil sensoriel',
              data: METRICS.map((m) => state.metrics[m.key]),
              backgroundColor: 'rgba(37, 99, 235, 0.18)',
              borderColor: theme.accent,
              borderWidth: 2,
              pointBackgroundColor: theme.accent,
              pointRadius: 3,
              pointHoverRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false, // D√©sactiv√© pour faciliter l'export PDF (snapshot imm√©diat)
            scales: {
              r: {
                beginAtZero: true,
                min: 0,
                max: 10,
                ticks: {
                  stepSize: 2,
                  color: theme.muted,
                  backdropColor: 'transparent',
                  showLabelBackdrop: false,
                  font: { size: 10 }
                },
                grid: {
                  color: 'rgba(148, 163, 184, 0.35)'
                },
                angleLines: {
                  color: 'rgba(148, 163, 184, 0.35)'
                },
                pointLabels: {
                  color: theme.text,
                  font: { size: 12 }
                }
              }
            },
            plugins: {
              legend: { display: false }
            }
          }
        });
      }

      // Met √† jour le th√®me du graphique. 
      // Peut accepter un param√®tre 'forcedTheme' ("light" ou "dark") pour l'export PDF.
      function updateChartTheme(forcedTheme) {
        if (!radarChart) return;
        
        const theme = getThemeTokens(forcedTheme);
        const scale = radarChart.options.scales.r;
        
        scale.ticks.color = theme.muted;
        scale.pointLabels.color = theme.text;
        scale.grid.color = theme.grid;
        scale.angleLines.color = theme.grid;
        
        radarChart.data.datasets[0].borderColor = theme.accent;
        radarChart.data.datasets[0].pointBackgroundColor = theme.accent;
        // Mise √† jour du background l√©g√®rement transparent mais teint√©
        radarChart.data.datasets[0].backgroundColor = forcedTheme === 'light' 
            ? 'rgba(37, 99, 235, 0.18)' 
            : (forcedTheme === 'dark' ? 'rgba(56, 189, 248, 0.18)' : 'rgba(37, 99, 235, 0.18)');

        radarChart.update('none');
      }

      function updateChart() {
        if (!radarChart) return;
        radarChart.data.datasets[0].data = METRICS.map((m) => state.metrics[m.key]);
        radarChart.update('none');
        
        // Mise √† jour de l'image pour le PDF "en direct" (optionnel, fait surtout au moment de l'export)
        // Mais on ne force pas le th√®me ici, on garde le WYSIWYG
        const imgPdf = document.getElementById('pdfRadar');
        if (imgPdf) {
          try {
            imgPdf.src = radarChart.toBase64Image('image/png', 1);
          } catch (e) {}
        }
      }

      // ---------------------- TOTAL / PDF ----------------------
      function updateTotal() {
        let sum = 0;
        SCORE_CATEGORIES.forEach((c) => {
          sum += state.scores[c.id] || 0;
        });
        const totalText = sum + ' / 100';
        const totalEl = document.getElementById('totalScore');
        if (totalEl) totalEl.textContent = totalText;
        const pdfTotalEl = document.getElementById('pdfTotal');
        if (pdfTotalEl) pdfTotalEl.textContent = totalText;
      }

      function renderPicks() {
        const host = document.getElementById('selectedAromas');
        if (!host) return;
        host.innerHTML = '';
        state.picks.forEach((label) => {
          const chip = document.createElement('span');
          const fam = labelToFam[label] || '';
          chip.className = 'chip' + (fam ? ' fam-' + fam : '');
          chip.textContent = label;
          chip.title = 'Cliquer pour supprimer';
          chip.addEventListener('click', () => {
            const idx = state.picks.indexOf(label);
            if (idx >= 0) {
              state.picks.splice(idx, 1);
              renderPicks();
              updatePreview();
            }
          });
          host.appendChild(chip);
        });

        const pdfHost = document.getElementById('pdfAromas');
        if (pdfHost) {
          pdfHost.innerHTML = '';
          state.picks.forEach((label) => {
            const chipPdf = document.createElement('span');
            const fam = labelToFam[label] || '';
            chipPdf.className = 'chip' + (fam ? ' fam-' + fam : '');
            chipPdf.textContent = label;
            pdfHost.appendChild(chipPdf);
          });
        }
      }

      function updatePreview() {
        const getVal = (id) => {
          const el = document.getElementById(id);
          return el && 'value' in el ? el.value : '';
        };
        const setText = (id, value) => {
          const el = document.getElementById(id);
          if (el) el.textContent = value;
        };

        setText('pdfDate', getVal('fDate'));
        setText('pdfName', getVal('fName'));
        setText('pdfDistillery', getVal('fDistillery'));
        setText('pdfBottler', getVal('fBottler'));
        setText('pdfAge', getVal('fAge'));
        setText('pdfVintage', getVal('fVintage'));
        setText('pdfColor', getVal('fColor'));

        const abvVal = getVal('fAbv');
        setText('pdfAbv', abvVal ? abvVal + ' %' : '');

        const notesEl = document.getElementById('fNotes');
        const notesPdf = document.getElementById('pdfNotes');
        if (notesPdf && notesEl) {
          notesPdf.textContent = notesEl.value || '';
        }

        const flagsEl = document.getElementById('pdfFlags');
        if (flagsEl) {
          flagsEl.innerHTML = '';
          const labels = {
            Cask: 'Brut de f√ªt',
            Single: 'F√ªt unique',
            Ncf: 'Non filtr√© √† froid',
            NoCol: 'Non color√©'
          };
          ['Cask', 'Single', 'Ncf', 'NoCol'].forEach((flag) => {
            const input = document.getElementById('f' + flag);
            if (input && input.checked) {
              const span = document.createElement('span');
              span.className = 'flag';
              span.textContent = labels[flag];
              flagsEl.appendChild(span);
            }
          });
        }

        const sectionsHost = document.getElementById('pdfNoteSections');
        if (sectionsHost) {
          sectionsHost.innerHTML = '';
          const GROUPS = [
            {
              title: 'Apparence',
              desc: '√âvaluer la viscosit√© (larmes), la brillance, et la limpidit√© du whisky.',
              items: ['attrait']
            },
            {
              title: 'Nez',
              desc: "Juger l'intensit√©, la complexit√© et l'√©quilibre des ar√¥mes.",
              items: ['nezInt', 'nezDist', 'nezEq']
            },
            {
              title: 'Palais',
              desc: '√âvaluer l\'√©quilibre des saveurs, la structure en bouche et la complexit√©.',
              items: ['palAlc', 'palCorps', 'palEq', 'palComplex', 'palDist']
            },
            {
              title: 'Finale',
              desc: 'Mesurer la longueur et la qualit√© des saveurs apr√®s d√©gustation.',
              items: ['finLen', 'finQual']
            }
          ];

          GROUPS.forEach((grp) => {
            const sec = document.createElement('div');
            sec.className = 'pdf-section';

            const h3 = document.createElement('h3');
            h3.textContent = grp.title;
            sec.appendChild(h3);

            const p = document.createElement('p');
            p.className = 'pdf-desc';
            p.textContent = grp.desc;
            sec.appendChild(p);

            grp.items.forEach((id) => {
              const cat = SCORE_CATEGORIES.find((c) => c.id === id);
              if (!cat) return;
              const row = document.createElement('div');
              row.className = 'criteria-row';
              const spLabel = document.createElement('span');
              spLabel.textContent = cat.label;
              const spVal = document.createElement('span');
              const val = state.scores[cat.id] || 0;
              spVal.textContent = val + ' / ' + cat.max;
              row.appendChild(spLabel);
              row.appendChild(spVal);
              sec.appendChild(row);
            });

            sectionsHost.appendChild(sec);
          });
        }

        updateTotal();
        // On ne met pas √† jour l'image du chart ici car pour l'export PDF,
        // nous avons besoin d'une logique sp√©cifique (force light mode).
      }

      // ---------------------- PALETTE D‚ÄôAR√îMES / TOOLTIP ----------------------
      const overlay = document.getElementById('paletteOverlay');
      const palSearch = document.getElementById('palSearch');
      const palResults = document.getElementById('palResults');
      const palClose = document.getElementById('palClose');
      const openPaletteBtn = document.getElementById('openPalette');
      const tooltip = document.getElementById('tooltip');

      function openOverlay() {
        if (!overlay) return;
        overlay.setAttribute('aria-hidden', 'false');
        overlay.classList.add('open');
        document.body.style.overflow = 'hidden';
        if (palSearch) {
          palSearch.value = '';
        }
        renderList('');
        setTimeout(() => {
          if (palSearch) palSearch.focus();
        }, 10);
      }

      function closeOverlay() {
        if (!overlay) return;
        overlay.setAttribute('aria-hidden', 'true');
        overlay.classList.remove('open');
        document.body.style.overflow = '';
        hideTip();
      }

      function renderList(q) {
        if (!palResults) return;
        const query = normalize(q);
        palResults.innerHTML = '';
        const items = FLAT.filter((x) => !query || normalize(x.label).includes(query) || normalize(x.path).includes(query));
        items.forEach((x) => {
          const row = document.createElement('div');
          row.className = 'row';
          row.setAttribute('role', 'option');
          row.dataset.label = x.label;
          const famCode = labelToFam[x.label] || '';
          const famClass = famCode ? ' fam-' + famCode : '';
          row.innerHTML = '<span class="leaf-badge' + famClass + '">' + x.label + '</span>' +
            '<span class="path">‚Äî ' + x.path + '</span>';

          if (state.picks.includes(x.label)) {
            row.setAttribute('aria-selected', 'true');
          }

          row.addEventListener('click', () => {
            const idx = state.picks.indexOf(x.label);
            if (idx >= 0) {
              state.picks.splice(idx, 1);
            } else {
              state.picks.push(x.label);
            }
            renderPicks();
            updatePreview();
            if (state.picks.includes(x.label)) {
              row.setAttribute('aria-selected', 'true');
            } else {
              row.removeAttribute('aria-selected');
            }
          });

          const mqlCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)');
          const isCoarse = mqlCoarse && mqlCoarse.matches;
          if (!isCoarse && tooltip) {
            row.addEventListener('mouseenter', (ev) => showTip(x.label, ev.clientX, ev.clientY));
            row.addEventListener('mousemove', (ev) => moveTip(ev.clientX, ev.clientY));
            row.addEventListener('mouseleave', hideTip);
          }

          palResults.appendChild(row);
        });
      }

      if (palSearch) {
        palSearch.addEventListener('input', (e) => {
          renderList(e.target.value);
        });
      }

      if (openPaletteBtn) openPaletteBtn.addEventListener('click', openOverlay);
      if (palClose) palClose.addEventListener('click', closeOverlay);
      if (overlay) {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) closeOverlay();
        });
      }
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && overlay && overlay.getAttribute('aria-hidden') === 'false') {
          closeOverlay();
        }
      });

      function showTip(label, x, y) {
        if (!tooltip) return;
        const d = INFO[label] || { classe: '‚Äî', compos√©s: '‚Äî', origine: '‚Äî', fut: '‚Äî', tips: '‚Äî', styles: '‚Äî' };
        tooltip.innerHTML = '<h4>' + label + ' <small>‚Ä¢ ' + d.classe + '</small></h4>' +
          '<div class="line"><div class="k">Compos√©s</div><div class="v">' + d.compos√©s + '</div></div>' +
          '<div class="line"><div class="k">Origine</div><div class="v">' + d.origine + '</div></div>' +
          '<div class="line"><div class="k">F√ªt</div><div class="v">' + d.fut + '</div></div>' +
          '<div class="line"><div class="k">D√©gustation</div><div class="v">' + d.tips + '</div></div>' +
          '<div class="line"><div class="k">Styles</div><div class="v">' + d.styles + '</div></div>';
        tooltip.style.display = 'block';
        tooltip.style.left = (x + 16) + 'px';
        tooltip.style.top = (y - 24) + 'px';
        tooltip.setAttribute('aria-hidden', 'false');
      }

      function moveTip(x, y) {
        if (!tooltip || tooltip.style.display !== 'block') return;
        tooltip.style.left = (x + 16) + 'px';
        tooltip.style.top = (y - 24) + 'px';
      }

      function hideTip() {
        if (!tooltip) return;
        tooltip.style.display = 'none';
        tooltip.setAttribute('aria-hidden', 'true');
      }

      const selectedAromasEl = document.getElementById('selectedAromas');
      if (selectedAromasEl && tooltip) {
        const mqlCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)');
        const isCoarse = mqlCoarse && mqlCoarse.matches;
        if (!isCoarse) {
          selectedAromasEl.addEventListener('mousemove', (e) => {
            const chip = e.target.closest('.chip');
            if (!chip) {
              hideTip();
              return;
            }
            const label = chip.textContent.trim();
            const rect = chip.getBoundingClientRect();
            showTip(label, rect.right, rect.top);
          });
          selectedAromasEl.addEventListener('mouseleave', hideTip);
        }
      }

      // ---------------------- EXPORT PDF ----------------------
      function initPdfExport() {
        const btnPdf = document.getElementById('exportPdf');
        if (!btnPdf) return;

        const pdfDateSpan = document.getElementById('pdfGeneratedOn');
        if (pdfDateSpan) {
          pdfDateSpan.textContent = new Date().toLocaleDateString('fr-FR');
        }

        btnPdf.addEventListener('click', () => {
          if (!window.html2pdf) {
            alert("La librairie de g√©n√©ration PDF n'a pas pu √™tre charg√©e. V√©rifiez votre connexion ou rechargez la page.");
            return;
          }

          updatePreview();
          try {
            window.scrollTo(0, 0);
          } catch (e) {}

          const pdfWrapper = document.getElementById('pdfTemplate');
          if (!pdfWrapper) return;
          
          // 1. Capture de l'√©tat actuel du graphique pour pouvoir le restaurer
          // On regarde si le root a le data-theme dark pour savoir quoi restaurer plus tard
          const currentTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';

          // 2. Forcer le graphique en mode LIGHT
          updateChartTheme('light');
          // Mise √† jour de l'image source pour le PDF avec le nouveau rendu
          const imgPdf = document.getElementById('pdfRadar');
          if (imgPdf && radarChart) {
             imgPdf.src = radarChart.toBase64Image('image/png', 1);
          }

          // Positionnement pour la capture
          pdfWrapper.style.display = 'block';
          pdfWrapper.style.position = 'fixed';
          pdfWrapper.style.left = '0';
          pdfWrapper.style.top = '0';
          pdfWrapper.style.zIndex = '1150';
          pdfWrapper.style.background = '#ffffff';

          const pdfElement = pdfWrapper.querySelector('.pdf-sheet') || pdfWrapper;

          const nameVal = (document.getElementById('fName') || {}).value || '';
          const slug = normalize(nameVal).replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '') || 'fiche';
          const dateVal = (document.getElementById('fDate') || {}).value || new Date().toISOString().split('T')[0];
          const filename = 'fiche-degustation-' + dateVal + '-' + slug + '.pdf';

          const opt = {
            margin: 10,
            filename,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, logging: false, scrollX: 0, scrollY: 0 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
          };

          startExportProgress();

          // D√©lai pour le rendu du DOM et du Chart mis √† jour
          setTimeout(() => {
            window.html2pdf().set(opt).from(pdfElement).save()
              .then(() => {
                // Restauration PDF DOM
                pdfWrapper.style.display = 'none';
                pdfWrapper.style.position = '';
                pdfWrapper.style.zIndex = '';
                pdfWrapper.style.background = '';
                
                // Restauration Chart Theme
                updateChartTheme(currentTheme);

                completeExportProgress(true);
              })
              .catch((err) => {
                console.error("Erreur export PDF:", err);
                pdfWrapper.style.display = 'none';
                updateChartTheme(currentTheme);
                completeExportProgress(false);
              });
          }, 500);
        });
      }

      // ---------------------- R√âINITIALISATION ----------------------
      function initReset() {
        const resetBtn = document.getElementById('resetAll');
        if (!resetBtn) return;
        resetBtn.addEventListener('click', () => {
          if (!confirm('Effacer tous les champs, notes et ar√¥mes ?')) return;

          document.querySelectorAll('.input').forEach((inp) => { inp.value = ''; });
          const fAbv = document.getElementById('fAbv');
          if (fAbv) fAbv.value = '';
          const fNotes = document.getElementById('fNotes');
          if (fNotes) fNotes.value = '';
          ['Cask', 'Single', 'Ncf', 'NoCol'].forEach((flag) => {
            const el = document.getElementById('f' + flag);
            if (el) el.checked = false;
          });

          METRICS.forEach((m) => {
            state.metrics[m.key] = 5;
            const slider = document.getElementById('m-' + m.key);
            if (slider) {
              slider.value = '5';
              const out = slider.parentElement && slider.parentElement.querySelector('output');
              if (out) out.textContent = '5';
            }
          });

          SCORE_CATEGORIES.forEach((c) => {
            state.scores[c.id] = 0;
            // Le slider custom
            const input = document.getElementById('s-' + c.id);
            if (input) {
              input.value = '0';
              // Dispatch event pour trigger updateField
              input.dispatchEvent(new Event('input'));
            }
          });

          state.picks = [];
          renderPicks();
          updatePreview();
        });
      }

      // ---------------------- INITIALISATION GLOBALE ----------------------
      function initDateField() {
        const dateInput = document.getElementById('fDate');
        if (dateInput && !dateInput.value) {
          dateInput.valueAsDate = new Date();
        }
      }

      function initInfoListeners() {
        const inputs = document.querySelectorAll('.input, #fNotes, .flags-grid input[type="checkbox"]');
        inputs.forEach((el) => {
          const evt = el.type === 'checkbox' ? 'change' : 'input';
          el.addEventListener(evt, () => {
            updatePreview();
          });
        });
      }

      function init() {
        initTheme();
        buildMetrics();
        buildScores();
        initRadarChart();
        initExportOverlay();
        initPdfExport();
        initReset();
        initDateField();
        initInfoListeners();
        renderPicks();
        updatePreview();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>